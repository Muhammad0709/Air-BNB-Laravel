import{b as ae,r as n,j as t,H as le}from"./app-BZPU0TFF.js";import{H as de}from"./HostLayout-0zmM1SPA.js";import{A as ce,S as q}from"./AttachFile-DRI-ivkP.js";import{a as J,V as xe,c as he}from"./chatApi-D2mwzw3U.js";import{M as me}from"./MoreVert-CbBXs543.js";import{A as pe}from"./Add-C06NsuRs.js";import{C as ue}from"./Close-Ddt_jW1T.js";import{R as ge,C as Q}from"./Row-Cvotj-uB.js";import{C as R,a as X}from"./CardContent-B4p7dtsI.js";import{B as v,S as d,I as w,M as fe,a as T,P as je}from"./ArrowDropDown-CdXTbv6H.js";import{B as o,T as a}from"./use-language-CBvUMsfX.js";import{A as k}from"./Menu-CWbzmUzk.js";import{T as be}from"./TextField-BJkH4-kg.js";import{D as Fe,a as ye,b as Ce,c as ve}from"./DialogTitle-BUJmJR9v.js";/* empty css            */import"./BookOnline-B3dxxSnO.js";import"./Hotel-TiQRpwwi.js";import"./Message-Cs-TFami.js";import"./Container-D7o5WA9F.js";function W(m){return{...m,sender:m.sender==="user"?"customer":m.sender,timestamp:m.timestamp}}function Ne(){const{props:m}=ae(),H=n.useRef(null),y=n.useRef(null),[l,E]=n.useState(null),[u,P]=n.useState(""),[g,A]=n.useState([]),[L,z]=n.useState({}),[S,f]=n.useState(!1),[j,b]=n.useState(null),[Z,O]=n.useState(!1),[ee,U]=n.useState(!1),D=n.useMemo(()=>(Array.isArray(m.conversations)?m.conversations:[]).map(s=>({...s,messages:[]})),[m.conversations]),[F,p]=n.useState(D);n.useEffect(()=>{p(e=>{const s=new Map(e.map(r=>[r.id,r]));for(const r of D)s.has(r.id)?s.set(r.id,{...r,messages:s.get(r.id).messages}):s.set(r.id,{...r,messages:[]});return Array.from(s.values()).sort((r,i)=>new Date(i.lastMessageTime).getTime()-new Date(r.lastMessageTime).getTime())})},[D]);const[M,G]=n.useState([]),[te,N]=n.useState(!1);n.useEffect(()=>{S&&(N(!0),J("/api/host/chat/users").then(e=>{const s=e.data?.users??[];G(s.map(r=>({id:r.id,name:r.name,email:r.email,avatar:r.avatar??""})))}).catch(()=>G([])).finally(()=>N(!1)))},[S]);const x=F.find(e=>e.id===l),V=n.useCallback(()=>{H.current?.scrollIntoView({behavior:"smooth"})},[]),B=n.useCallback((e,s)=>{p(r=>r.map(i=>i.id!==e||i.messages.some(c=>c.id===s.id)?i:{...i,messages:[...i.messages,s]}))},[]);n.useEffect(()=>{if(!l)return;const e=F.find(s=>s.id===l);e&&e.messages.length>0||(O(!0),J(`/api/host/chat/conversations/${l}`).then(s=>{const r=(s.data.messages??[]).map(i=>W({id:i.id,text:i.text,sender:i.sender,timestamp:i.timestamp,read:i.read,files:i.files??null}));p(i=>i.map(c=>c.id===l?{...c,messages:r}:c))}).catch(()=>{}).finally(()=>O(!1)))},[l,F]),n.useEffect(()=>{if(!l||typeof window>"u"||!window.Echo)return;const e=`conversation.${l}`,s=window.Echo,r=c=>{const h=c;!h||h.id==null||B(l,W({id:h.id,text:h.text,sender:h.sender??"user",timestamp:h.timestamp??new Date().toISOString(),read:h.read??!1,files:h.files??null}))},i=s.private(e);return i.listen(".message.sent",r),()=>{try{i.leave?.()}catch{}}},[l,B]),n.useEffect(()=>{x&&V()},[x?.messages,V,x]);const se=e=>{if(e.target.files){const s=Array.from(e.target.files);A(r=>[...r,...s])}},re=e=>{A(s=>s.filter((r,i)=>i!==e))},Y=async()=>{if(!u.trim()&&g.length===0||!l)return;U(!0);const e=new FormData;e.append("message",u.trim()),g.forEach(s=>e.append("files[]",s));try{const r=(await he(`/api/host/chat/conversations/${l}/messages`,e)).data?.message;if(r){const i=W({id:r.id,text:r.text,sender:"host",timestamp:r.timestamp??new Date().toISOString(),read:r.read,files:r.files??null});B(l,i);const c=u.trim()||"";p(h=>h.map(I=>I.id===l?{...I,lastMessage:c,lastMessageTime:new Date().toISOString()}:I))}P(""),A([]),y.current&&(y.current.value="")}finally{U(!1)}},ie=e=>{e.key==="Enter"&&!e.shiftKey&&(e.preventDefault(),Y())},_=e=>(typeof e=="string"?new Date(e):e).toLocaleTimeString("en-US",{hour:"2-digit",minute:"2-digit"}),K=e=>{const s=typeof e=="string"?new Date(e):e,r=new Date,i=new Date(r);return i.setDate(i.getDate()-1),s.toDateString()===r.toDateString()?"Today":s.toDateString()===i.toDateString()?"Yesterday":s.toLocaleDateString("en-US",{month:"short",day:"numeric"})},oe=(e,s)=>{z(r=>({...r,[e]:s.currentTarget}))},C=e=>{z(s=>({...s,[e]:null}))},ne=e=>{const s=M.find(r=>r.id===e);if(s){const r=F.find(i=>i.customerName===s.name);if(r)E(r.id);else{const i={id:Date.now(),customerName:s.name,customerAvatar:s.avatar,property:"New Property",lastMessage:"",lastMessageTime:new Date().toISOString(),unreadCount:0,messages:[]};p(c=>[i,...c]),E(i.id)}}f(!1),b(null)},$=e=>e.lastMessage.includes("image")||e.lastMessage.includes("video")?"":e.lastMessage;return t.jsxs(t.Fragment,{children:[t.jsx(le,{title:"Messages"}),t.jsxs(de,{title:"Messages",children:[t.jsxs(ge,{children:[t.jsx(Q,{xs:12,md:4,lg:3,children:t.jsxs(R,{elevation:0,sx:{border:"1px solid #E5E7EB",borderRadius:2,height:"calc(100vh - 200px)",overflow:"hidden",display:"flex",flexDirection:"column"},children:[t.jsx(X,{sx:{p:2},children:t.jsx(v,{variant:"contained",startIcon:t.jsx(pe,{}),fullWidth:!0,onClick:()=>f(!0),sx:{bgcolor:"#AD542D",textTransform:"none",fontWeight:700,borderRadius:2,mb:2,py:1.5,"&:hover":{bgcolor:"#78381C"}},children:"Start Conversation"})}),t.jsx(X,{sx:{p:0,flex:1,overflowY:"auto"},children:F.map(e=>t.jsx(o,{onClick:()=>{E(e.id),p(s=>s.map(r=>r.id===e.id?{...r,unreadCount:0}:r))},sx:{p:2,borderBottom:"1px solid #E5E7EB",cursor:"pointer",bgcolor:l===e.id?"#FFF5F7":"transparent",position:"relative","&:hover":{bgcolor:l===e.id?"#FFF5F7":"#F9FAFB"}},children:t.jsxs(d,{direction:"row",spacing:2,useFlexGap:!0,alignItems:"flex-start",children:[t.jsx(k,{src:e.customerAvatar??void 0,sx:{bgcolor:"#AD542D",width:48,height:48},children:e.customerName.charAt(0)}),t.jsxs(o,{sx:{flex:1,minWidth:0},children:[t.jsxs(d,{direction:"row",justifyContent:"space-between",alignItems:"center",sx:{mb:.5},children:[t.jsx(a,{variant:"subtitle2",sx:{fontWeight:700,color:"#222222"},children:e.customerName}),t.jsxs(d,{direction:"row",spacing:1,useFlexGap:!0,alignItems:"center",children:[t.jsx(a,{variant:"caption",sx:{color:"#9CA3AF"},children:K(e.lastMessageTime)}),t.jsx(w,{size:"small",onClick:s=>{s.stopPropagation(),oe(e.id,s)},sx:{p:.5},children:t.jsx(me,{sx:{fontSize:18,color:"#9CA3AF"}})}),t.jsxs(fe,{anchorEl:L[e.id],open:!!L[e.id],onClose:()=>C(e.id),children:[t.jsx(T,{onClick:()=>C(e.id),children:"Archive"}),t.jsx(T,{onClick:()=>C(e.id),children:"Delete"}),t.jsx(T,{onClick:()=>C(e.id),children:"Mute"})]})]})]}),t.jsxs(d,{direction:"row",justifyContent:"space-between",alignItems:"center",children:[$(e)&&t.jsx(a,{variant:"body2",sx:{color:e.unreadCount>0?"#222222":"#717171",fontWeight:e.unreadCount>0?600:400,overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap",flex:1,marginInlineEnd:1},children:$(e)}),e.unreadCount>0&&t.jsx(o,{sx:{bgcolor:"#AD542D",color:"#FFFFFF",borderRadius:"50%",width:20,height:20,display:"flex",alignItems:"center",justifyContent:"center",fontSize:"0.75rem",fontWeight:700},children:e.unreadCount})]})]})]})},e.id))})]})}),t.jsx(Q,{xs:12,md:8,lg:9,children:x?t.jsxs(R,{elevation:0,sx:{border:"1px solid #E5E7EB",borderRadius:2,height:"calc(100vh - 200px)",display:"flex",flexDirection:"column"},children:[t.jsx(o,{sx:{p:2,borderBottom:"1px solid #E5E7EB"},children:t.jsx(d,{direction:"row",spacing:2,useFlexGap:!0,alignItems:"center",justifyContent:"space-between",children:t.jsxs(d,{direction:"row",spacing:2,useFlexGap:!0,alignItems:"center",children:[t.jsx(k,{src:x.customerAvatar??void 0,sx:{bgcolor:"#AD542D",width:40,height:40},children:x.customerName.charAt(0)}),t.jsxs(o,{children:[t.jsx(a,{variant:"subtitle1",sx:{fontWeight:700,color:"#222222"},children:x.customerName}),t.jsx(a,{variant:"caption",sx:{color:"#717171"},children:x.property})]})]})})}),t.jsxs(o,{sx:{flex:1,overflowY:"auto",p:2,bgcolor:"#F9FAFB"},children:[Z?t.jsx(o,{sx:{textAlign:"center",py:4},children:t.jsx(a,{variant:"body2",sx:{color:"#717171"},children:"Loading messages…"})}):t.jsx(t.Fragment,{children:x.messages.map((e,s)=>{const r=s===0||new Date(e.timestamp).toDateString()!==new Date(x.messages[s-1].timestamp).toDateString();return t.jsxs(o,{children:[r&&t.jsx(o,{sx:{textAlign:"center",my:2},children:t.jsx(a,{variant:"caption",sx:{color:"#9CA3AF",bgcolor:"#F9FAFB",px:2,py:.5,borderRadius:1},children:K(e.timestamp)})}),t.jsx(d,{direction:"row",justifyContent:e.sender==="host"?"flex-end":"flex-start",sx:{mb:1.5},children:e.files&&e.files.length>0&&!e.text?t.jsxs(o,{sx:{maxWidth:"70%",position:"relative"},children:[t.jsx(d,{spacing:1,children:e.files.map(i=>t.jsx(o,{sx:{position:"relative"},children:i.type==="image"?t.jsx(o,{component:"img",src:i.url,alt:i.name,sx:{maxWidth:"100%",maxHeight:300,borderRadius:2,objectFit:"cover",cursor:"pointer",display:"block"},onClick:()=>window.open(i.url,"_blank")}):t.jsx(o,{sx:{borderRadius:2,overflow:"hidden",maxHeight:300},children:t.jsx("video",{src:i.url,style:{maxWidth:"100%",maxHeight:300,display:"block"},controls:!0})})},i.id))}),t.jsx(a,{variant:"caption",sx:{color:"#9CA3AF",fontSize:"0.7rem",display:"block",mt:.5,textAlign:e.sender==="host"?"right":"left"},children:_(e.timestamp)})]}):t.jsxs(je,{elevation:0,sx:{p:1.5,maxWidth:"70%",bgcolor:e.sender==="host"?"#AD542D":"#FFFFFF",color:e.sender==="host"?"#FFFFFF":"#222222",borderRadius:2,border:e.sender==="customer"?"1px solid #E5E7EB":"none"},children:[e.files&&e.files.length>0&&t.jsx(d,{spacing:1,sx:{mb:e.text?1:0},children:e.files.map(i=>t.jsx(o,{children:i.type==="image"?t.jsx(o,{component:"img",src:i.url,alt:i.name,sx:{maxWidth:"100%",maxHeight:300,borderRadius:1,objectFit:"cover",cursor:"pointer"},onClick:()=>window.open(i.url,"_blank")}):t.jsx(o,{sx:{position:"relative",bgcolor:"rgba(0,0,0,0.5)",borderRadius:1,overflow:"hidden",minHeight:200,display:"flex",alignItems:"center",justifyContent:"center"},children:t.jsx("video",{src:i.url,style:{maxWidth:"100%",maxHeight:300,borderRadius:4},controls:!0})})},i.id))}),e.text&&t.jsx(a,{variant:"body2",sx:{mb:.5},children:e.text}),t.jsx(a,{variant:"caption",sx:{color:e.sender==="host"?"rgba(255,255,255,0.7)":"#9CA3AF",fontSize:"0.7rem"},children:_(e.timestamp)})]})})]},e.id)})}),t.jsx("div",{ref:H})]}),g.length>0&&t.jsx(o,{sx:{p:2,borderTop:"1px solid #E5E7EB",bgcolor:"#FFFFFF"},children:t.jsx(d,{direction:"row",spacing:1,useFlexGap:!0,sx:{flexWrap:"wrap",gap:1},children:g.map((e,s)=>t.jsxs(o,{sx:{position:"relative",border:"1px solid #E5E7EB",borderRadius:1,overflow:"hidden",width:80,height:80},children:[e.type.startsWith("image/")?t.jsx(o,{component:"img",src:URL.createObjectURL(e),alt:e.name,sx:{width:"100%",height:"100%",objectFit:"cover"}}):t.jsx(o,{sx:{width:"100%",height:"100%",display:"flex",alignItems:"center",justifyContent:"center",bgcolor:"#F9FAFB"},children:t.jsx(xe,{sx:{fontSize:32,color:"#717171"}})}),t.jsx(w,{size:"small",onClick:()=>re(s),sx:{position:"absolute",top:4,right:4,bgcolor:"rgba(0,0,0,0.5)",color:"#FFFFFF",width:20,height:20,"&:hover":{bgcolor:"rgba(0,0,0,0.7)"}},children:"×"})]},s))})}),t.jsx(o,{sx:{p:2,borderTop:"1px solid #E5E7EB"},children:t.jsxs(d,{direction:"row",spacing:1,useFlexGap:!0,alignItems:"flex-end",children:[t.jsx("input",{type:"file",ref:y,onChange:se,accept:"image/*,video/*",multiple:!0,style:{display:"none"}}),t.jsx(w,{onClick:()=>y.current?.click(),sx:{border:"1px solid #E5E7EB",borderRadius:2,width:40,height:40,color:"#717171","&:hover":{bgcolor:"#F9FAFB",borderColor:"#AD542D"}},children:t.jsx(ce,{})}),t.jsx(be,{fullWidth:!0,placeholder:"Type a message...",value:u,onChange:e=>P(e.target.value),onKeyPress:ie,multiline:!0,maxRows:4,size:"small",sx:{"& .MuiOutlinedInput-root":{borderRadius:2,bgcolor:"#FFFFFF","& fieldset":{borderColor:"#E5E7EB"}}}}),t.jsx(v,{variant:"contained",onClick:()=>void Y(),disabled:ee||!u.trim()&&g.length===0,sx:{bgcolor:"#AD542D",borderRadius:2,minWidth:48,height:40,"&:hover":{bgcolor:"#78381C"},"&:disabled":{bgcolor:"#E5E7EB",color:"#9CA3AF"}},children:t.jsx(q,{})})]})})]}):t.jsx(R,{elevation:0,sx:{border:"1px solid #E5E7EB",borderRadius:2,height:"calc(100vh - 200px)",display:"flex",alignItems:"center",justifyContent:"center"},children:t.jsxs(o,{sx:{textAlign:"center"},children:[t.jsx(o,{sx:{width:80,height:80,borderRadius:"50%",border:"2px solid #E5E7EB",display:"flex",alignItems:"center",justifyContent:"center",mx:"auto",mb:2},children:t.jsx(q,{sx:{fontSize:40,color:"#9CA3AF"}})}),t.jsx(a,{variant:"h6",sx:{color:"#6B7280",mb:1},children:"Select a conversation"}),t.jsx(a,{variant:"body2",sx:{color:"#9CA3AF"},children:"Choose a conversation from the list to start messaging, or create a new one."})]})})})]}),t.jsxs(Fe,{open:S,onClose:()=>{f(!1),b(null)},maxWidth:"sm",fullWidth:!0,PaperProps:{sx:{borderRadius:2,maxHeight:"80vh"}},children:[t.jsxs(ye,{sx:{pb:1,display:"flex",justifyContent:"space-between",alignItems:"center"},children:[t.jsx(a,{variant:"h6",sx:{fontWeight:700,color:"#222222"},children:"Start Conversation"}),t.jsx(w,{onClick:()=>{f(!1),b(null)},sx:{color:"#717171"},children:t.jsx(ue,{})})]}),t.jsxs(Ce,{sx:{p:0},children:[t.jsx(a,{variant:"body2",sx:{px:3,pb:2,color:"#717171"},children:"Select Participants"}),t.jsx(o,{sx:{maxHeight:"50vh",overflowY:"auto"},children:te?t.jsx(o,{sx:{py:4,textAlign:"center"},children:t.jsx(a,{variant:"body2",sx:{color:"#717171"},children:"Loading users..."})}):M.length===0?t.jsx(o,{sx:{py:4,textAlign:"center"},children:t.jsx(a,{variant:"body2",sx:{color:"#717171"},children:"No users found."})}):M.map(e=>t.jsx(o,{onClick:()=>b(e.id),sx:{px:3,py:2,cursor:"pointer",bgcolor:j===e.id?"#FFF5F7":"transparent",borderBottom:"1px solid #E5E7EB","&:hover":{bgcolor:j===e.id?"#FFF5F7":"#F9FAFB"}},children:t.jsxs(d,{direction:"row",spacing:2,useFlexGap:!0,alignItems:"center",children:[t.jsx(k,{src:e.avatar||void 0,sx:{bgcolor:"#AD542D",width:40,height:40},children:e.name.charAt(0)}),t.jsxs(o,{sx:{flex:1},children:[t.jsx(a,{variant:"subtitle2",sx:{fontWeight:700,color:"#222222",mb:.5},children:e.name}),t.jsx(a,{variant:"body2",sx:{color:"#717171",fontSize:"0.875rem"},children:e.email})]})]})},e.id))})]}),t.jsxs(ve,{sx:{p:2,borderTop:"1px solid #E5E7EB"},children:[t.jsx(v,{onClick:()=>{f(!1),b(null)},sx:{color:"#717171",textTransform:"none",fontWeight:600},children:"Cancel"}),t.jsx(v,{onClick:()=>j&&ne(j),disabled:!j,variant:"contained",sx:{bgcolor:"#AD542D",textTransform:"none",fontWeight:700,borderRadius:2,px:3,"&:hover":{bgcolor:"#78381C"},"&:disabled":{bgcolor:"#E5E7EB",color:"#9CA3AF"}},children:"Start"})]})]})]})]})}export{Ne as default};
