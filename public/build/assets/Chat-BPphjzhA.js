import{b as fe,r as a,a as re,j as t,H as je}from"./app-kf1cIShR.js";import{N as be,F as Fe}from"./Footer-CMCR6c7C.js";import{u as ye,B as n,T as l}from"./use-language-C8T1lNpe.js";import{A as ve,S as oe}from"./AttachFile--cxUD5P8.js";import{a as ie,b as Ce,V as we,c as Ae}from"./chatApi-CfE8eLwp.js";import{M as Ee}from"./MoreVert-CpMgRg51.js";import{A as De}from"./Add-DgSHdF0H.js";import{C as Se}from"./Close-DamT0U9D.js";import{C as Ie}from"./Container-DHhHaL4P.js";import{R as Me,C as ne}from"./Row-Cb5poqVh.js";import{C as L,a as Te}from"./CardContent-JM2M2v2P.js";import{B as T,S as d,I as B,M as Be,a as G,P as Re}from"./ArrowDropDown-DWMWMKcd.js";import{A as R}from"./Menu-CN5VpIUh.js";import{T as We}from"./TextField-DiIfVKtJ.js";import{D as ke,a as Pe,b as _e,c as He}from"./DialogTitle-DhjBvyrz.js";/* empty css            */import"./Message-DB_7vqpa.js";function O(i){return{id:Number(i.id),text:i.text,sender:i.sender==="user"||i.sender==="customer"?"customer":"host",timestamp:i.timestamp??new Date().toISOString(),read:i.read??!1,files:i.files??null}}function ze(i,g){return i?{...i,id:Number(i.id),propertyId:i.propertyId??g,messages:i.messages??[]}:null}function Ne(i){return(i.data?.messages??[]).map(O)}function Le(i,g){return i.some(h=>h.id===g.id)?i:[g,...i].sort((h,A)=>new Date(A.lastMessageTime).getTime()-new Date(h.lastMessageTime).getTime())}function it(){const{t:i}=ye(),{url:g,props:h}=fe(),A=a.useMemo(()=>{const e=g.includes("?")?g.split("?")[1]:"";return new URLSearchParams(e)},[g]),ae=a.useRef(null),U=a.useRef(null),E=a.useRef(null),[c,D]=a.useState(null),[b,Y]=a.useState(""),[F,W]=a.useState([]),[K,V]=a.useState({}),[k,y]=a.useState(!1),[v,C]=a.useState(null),f=a.useMemo(()=>Array.isArray(h.propertiesToMessage)?h.propertiesToMessage:[],[h.propertiesToMessage]),[$,P]=a.useState(f),[le,_]=a.useState(!1),[S,I]=a.useState(!1),[ce,q]=a.useState(!1),[de,J]=a.useState(!1),H=a.useMemo(()=>(Array.isArray(h.conversations)?h.conversations:[]).map(s=>({...s,messages:[]})),[h.conversations]),[m,j]=a.useState(H);a.useEffect(()=>{j(e=>{const s=new Map(e.map(o=>[o.id,o]));for(const o of H)if(!s.has(o.id))s.set(o.id,{...o,messages:[]});else{const r=s.get(o.id);s.set(o.id,{...o,messages:r.messages})}return Array.from(s.values()).sort((o,r)=>new Date(r.lastMessageTime).getTime()-new Date(o.lastMessageTime).getTime())})},[H]),a.useEffect(()=>{if(k){if(f.length>0){P(f),_(!1);return}_(!0),ie("/api/messages/properties-to-message").then(e=>P(e.data?.properties??[])).catch(()=>P([])).finally(()=>_(!1))}},[k,f]);const p=m.find(e=>e.id===c),X=a.useMemo(()=>f.filter(e=>!m.some(s=>s.propertyId===e.propertyId)),[f,m]),w=a.useCallback(async e=>{const o=(await Ce("/api/messages/conversations",{property_id:e})).data?.conversation,r=ze(o,e);return r?(j(x=>Le(x,r)),setTimeout(()=>D(r.id),0),r.id):null},[]),xe=a.useCallback(async e=>{I(!0);try{await w(e)}catch{D(null)}finally{I(!1)}},[w]),Q=a.useCallback(()=>{const e=U.current;e&&(e.scrollTop=e.scrollHeight)},[]),z=a.useCallback((e,s)=>{j(o=>o.map(r=>r.id!==e||r.messages.some(x=>x.id===s.id)?r:{...r,messages:[...r.messages,s]}))},[]);a.useEffect(()=>{const e=A.get("property_id"),s=e?parseInt(e,10):null;if(!s)return;const o=m.find(r=>r.propertyId===s);if(o){D(o.id),re.visit("/chat");return}w(s).catch(()=>{}).finally(()=>re.visit("/chat"))},[A,m,w]),a.useEffect(()=>{!c||m.find(s=>s.id===c)?.messages.length||(q(!0),ie(`/api/messages/conversations/${c}`).then(s=>{const o=Ne(s);j(r=>r.map(x=>x.id===c?{...x,messages:o}:x))}).catch(()=>{}).finally(()=>q(!1)))},[c,m]),a.useEffect(()=>{if(!c||typeof window>"u"||!window.Echo)return;const e=`conversation.${c}`,s=window.Echo,o=x=>{const u=x;!u||u.id==null||z(c,O({id:u.id,text:u.text,sender:u.sender??"host",timestamp:u.timestamp??new Date().toISOString(),read:u.read??!1,files:u.files??null}))},r=s.private(e);return r.listen(".message.sent",o),()=>{try{r.leave?.()}catch{}}},[c,z]),a.useEffect(()=>{p&&Q()},[p?.messages,Q,p]);const he=e=>{if(e.target.files){const s=Array.from(e.target.files);W(o=>[...o,...s])}},pe=e=>{W(s=>s.filter((o,r)=>r!==e))},Z=async()=>{if(!b.trim()&&F.length===0||!c)return;J(!0);const e=new FormData;e.append("message",b.trim()),F.forEach(s=>e.append("files[]",s));try{const o=(await Ae(`/api/messages/conversations/${c}/messages`,e)).data?.message;if(o){const r=O(o);z(c,r);const x=b.trim()||"";j(u=>u.map(N=>N.id===c?{...N,lastMessage:x,lastMessageTime:new Date().toISOString()}:N))}Y(""),W([]),E.current&&(E.current.value="")}finally{J(!1)}},ue=e=>{e.key==="Enter"&&!e.shiftKey&&(e.preventDefault(),Z())},ee=e=>(typeof e=="string"?new Date(e):e).toLocaleTimeString("en-US",{hour:"2-digit",minute:"2-digit"}),te=e=>{const s=typeof e=="string"?new Date(e):e,o=new Date,r=new Date(o);return r.setDate(r.getDate()-1),s.toDateString()===o.toDateString()?"Today":s.toDateString()===r.toDateString()?"Yesterday":s.toLocaleDateString("en-US",{month:"short",day:"numeric"})},ge=(e,s)=>{V(o=>({...o,[e]:s.currentTarget}))},M=e=>{V(s=>({...s,[e]:null}))},me=async()=>{if(v){I(!0);try{await w(v),y(!1),C(null)}finally{I(!1)}}},se=e=>e.lastMessage.includes("image")||e.lastMessage.includes("video")?"":e.lastMessage;return t.jsxs(n,{children:[t.jsx(je,{title:i("chat.messages")}),t.jsx(be,{}),t.jsx(n,{sx:{minHeight:"100vh",bgcolor:"#FFFFFF",py:4},children:t.jsxs(Ie,{children:[t.jsxs(n,{sx:{mb:4},children:[t.jsx(l,{variant:"h2",sx:{fontSize:"2.5rem",fontWeight:800,color:"#222222",mb:1},children:i("chat.messages")}),t.jsx(l,{variant:"body1",sx:{color:"#717171",fontSize:"1rem"},children:i("chat.chat_with_hosts")})]}),t.jsxs(Me,{children:[t.jsx(ne,{xs:12,md:4,lg:3,children:t.jsx(L,{elevation:0,sx:{border:"1px solid #E5E7EB",borderRadius:2,height:"calc(100vh - 250px)",overflow:"hidden",display:"flex",flexDirection:"column"},children:t.jsxs(Te,{sx:{p:0,flex:1,minHeight:0,overflowY:"scroll",display:"flex",flexDirection:"column"},children:[t.jsxs(n,{sx:{p:2,flex:"0 0 auto"},children:[t.jsx(T,{variant:"contained",startIcon:t.jsx(De,{}),fullWidth:!0,onClick:()=>y(!0),sx:{bgcolor:"#AD542D",textTransform:"none",fontWeight:700,borderRadius:2,mb:2,py:1.5,"&:hover":{bgcolor:"#78381C"}},children:i("chat.start_conversation")}),X.length>0&&t.jsxs(t.Fragment,{children:[t.jsx(l,{variant:"subtitle2",sx:{fontWeight:700,color:"#717171",mb:1,px:.5},children:i("chat.select_property")}),t.jsx(n,{sx:{overflowX:"hidden",pr:.5},children:X.map(e=>t.jsx(n,{onClick:()=>xe(e.propertyId),sx:{p:1.5,mb:.5,borderRadius:1.5,cursor:"pointer",border:"1px solid #E5E7EB","&:hover":{bgcolor:"#F9FAFB",borderColor:"#AD542D"},opacity:S?.7:1,pointerEvents:S?"none":"auto"},children:t.jsxs(d,{direction:"row",spacing:1.5,useFlexGap:!0,alignItems:"center",children:[t.jsx(R,{src:e.hostAvatar??void 0,sx:{bgcolor:"#AD542D",width:40,height:40},children:e.hostName.charAt(0)}),t.jsxs(n,{sx:{minWidth:0,flex:1},children:[t.jsx(l,{variant:"body2",sx:{fontWeight:600,color:"#222222"},children:e.hostName}),t.jsx(l,{variant:"caption",sx:{color:"#717171",display:"block",overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap"},children:e.property})]})]})},e.propertyId))})]})]}),t.jsx(n,{sx:{flex:"0 0 auto"},children:m.map(e=>t.jsx(n,{onClick:()=>{D(e.id),j(s=>s.map(o=>o.id===e.id?{...o,unreadCount:0}:o))},sx:{p:2,borderBottom:"1px solid #E5E7EB",cursor:"pointer",bgcolor:c===e.id?"#FFF5F7":"transparent",position:"relative","&:hover":{bgcolor:c===e.id?"#FFF5F7":"#F9FAFB"}},children:t.jsxs(d,{direction:"row",spacing:2,useFlexGap:!0,alignItems:"flex-start",children:[t.jsx(R,{src:e.hostAvatar??void 0,sx:{bgcolor:"#AD542D",width:48,height:48},children:e.hostName.charAt(0)}),t.jsxs(n,{sx:{flex:1,minWidth:0},children:[t.jsxs(d,{direction:"row",justifyContent:"space-between",alignItems:"center",sx:{mb:.5},children:[t.jsx(l,{variant:"subtitle2",sx:{fontWeight:700,color:"#222222"},children:e.hostName}),t.jsxs(d,{direction:"row",spacing:1,useFlexGap:!0,alignItems:"center",children:[t.jsx(l,{variant:"caption",sx:{color:"#9CA3AF"},children:te(e.lastMessageTime)}),t.jsx(B,{size:"small",onClick:s=>{s.stopPropagation(),ge(e.id,s)},sx:{p:.5},children:t.jsx(Ee,{sx:{fontSize:18,color:"#9CA3AF"}})}),t.jsxs(Be,{anchorEl:K[e.id],open:!!K[e.id],onClose:()=>M(e.id),children:[t.jsx(G,{onClick:()=>M(e.id),children:"Archive"}),t.jsx(G,{onClick:()=>M(e.id),children:"Delete"}),t.jsx(G,{onClick:()=>M(e.id),children:"Mute"})]})]})]}),t.jsxs(d,{direction:"row",justifyContent:"space-between",alignItems:"center",children:[se(e)&&t.jsx(l,{variant:"body2",sx:{color:e.unreadCount>0?"#222222":"#717171",fontWeight:e.unreadCount>0?600:400,overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap",flex:1,marginInlineEnd:1},children:se(e)}),e.unreadCount>0&&t.jsx(n,{sx:{bgcolor:"#AD542D",color:"#FFFFFF",borderRadius:"50%",width:20,height:20,display:"flex",alignItems:"center",justifyContent:"center",fontSize:"0.75rem",fontWeight:700},children:e.unreadCount})]})]})]})},e.id))})]})})}),t.jsx(ne,{xs:12,md:8,lg:9,children:p?t.jsxs(L,{elevation:0,sx:{border:"1px solid #E5E7EB",borderRadius:2,height:"calc(100vh - 250px)",display:"flex",flexDirection:"column"},children:[t.jsx(n,{sx:{p:2,borderBottom:"1px solid #E5E7EB"},children:t.jsx(d,{direction:"row",spacing:2,useFlexGap:!0,alignItems:"center",justifyContent:"space-between",children:t.jsxs(d,{direction:"row",spacing:2,useFlexGap:!0,alignItems:"center",children:[t.jsx(R,{src:p.hostAvatar??void 0,sx:{bgcolor:"#AD542D",width:40,height:40},children:p.hostName.charAt(0)}),t.jsxs(n,{children:[t.jsx(l,{variant:"subtitle1",sx:{fontWeight:700,color:"#222222"},children:p.hostName}),t.jsx(l,{variant:"caption",sx:{color:"#717171"},children:p.property})]})]})})}),t.jsxs(n,{ref:U,sx:{flex:1,overflowY:"auto",p:2,bgcolor:"#F9FAFB"},children:[ce?t.jsx(n,{sx:{textAlign:"center",py:4},children:t.jsx(l,{variant:"body2",sx:{color:"#717171"},children:i("chat.loading")})}):t.jsx(t.Fragment,{children:p.messages.map((e,s)=>{const o=s===0||new Date(e.timestamp).toDateString()!==new Date(p.messages[s-1].timestamp).toDateString();return t.jsxs(n,{children:[o&&t.jsx(n,{sx:{textAlign:"center",my:2},children:t.jsx(l,{variant:"caption",sx:{color:"#9CA3AF",bgcolor:"#F9FAFB",px:2,py:.5,borderRadius:1},children:te(e.timestamp)})}),t.jsx(d,{direction:"row",justifyContent:e.sender==="customer"?"flex-end":"flex-start",sx:{mb:1.5},children:e.files&&e.files.length>0&&!e.text?t.jsxs(n,{sx:{maxWidth:"70%",position:"relative"},children:[t.jsx(d,{spacing:1,children:e.files.map(r=>t.jsx(n,{sx:{position:"relative"},children:r.type==="image"?t.jsx(n,{component:"img",src:r.url,alt:r.name,sx:{maxWidth:"100%",maxHeight:300,borderRadius:2,objectFit:"cover",cursor:"pointer",display:"block"},onClick:()=>window.open(r.url,"_blank")}):t.jsx(n,{sx:{borderRadius:2,overflow:"hidden",maxHeight:300},children:t.jsx("video",{src:r.url,style:{maxWidth:"100%",maxHeight:300,display:"block"},controls:!0})})},r.id))}),t.jsx(l,{variant:"caption",sx:{color:"#9CA3AF",fontSize:"0.7rem",display:"block",mt:.5,textAlign:e.sender==="customer"?"right":"left"},children:ee(e.timestamp)})]}):t.jsxs(Re,{elevation:0,sx:{p:1.5,maxWidth:"70%",bgcolor:e.sender==="customer"?"#AD542D":"#FFFFFF",color:e.sender==="customer"?"#FFFFFF":"#222222",borderRadius:2,border:e.sender==="host"?"1px solid #E5E7EB":"none"},children:[e.files&&e.files.length>0&&t.jsx(d,{spacing:1,sx:{mb:e.text?1:0},children:e.files.map(r=>t.jsx(n,{children:r.type==="image"?t.jsx(n,{component:"img",src:r.url,alt:r.name,sx:{maxWidth:"100%",maxHeight:300,borderRadius:1,objectFit:"cover",cursor:"pointer"},onClick:()=>window.open(r.url,"_blank")}):t.jsx(n,{sx:{position:"relative",bgcolor:"rgba(0,0,0,0.5)",borderRadius:1,overflow:"hidden",minHeight:200,display:"flex",alignItems:"center",justifyContent:"center"},children:t.jsx("video",{src:r.url,style:{maxWidth:"100%",maxHeight:300,borderRadius:4},controls:!0})})},r.id))}),e.text&&t.jsx(l,{variant:"body2",sx:{mb:.5},children:e.text}),t.jsx(l,{variant:"caption",sx:{color:e.sender==="customer"?"rgba(255,255,255,0.7)":"#9CA3AF",fontSize:"0.7rem"},children:ee(e.timestamp)})]})})]},e.id)})}),t.jsx("div",{ref:ae})]}),F.length>0&&t.jsx(n,{sx:{p:2,borderTop:"1px solid #E5E7EB",bgcolor:"#FFFFFF"},children:t.jsx(d,{direction:"row",spacing:1,useFlexGap:!0,sx:{flexWrap:"wrap",gap:1},children:F.map((e,s)=>t.jsxs(n,{sx:{position:"relative",border:"1px solid #E5E7EB",borderRadius:1,overflow:"hidden",width:80,height:80},children:[e.type.startsWith("image/")?t.jsx(n,{component:"img",src:URL.createObjectURL(e),alt:e.name,sx:{width:"100%",height:"100%",objectFit:"cover"}}):t.jsx(n,{sx:{width:"100%",height:"100%",display:"flex",alignItems:"center",justifyContent:"center",bgcolor:"#F9FAFB"},children:t.jsx(we,{sx:{fontSize:32,color:"#717171"}})}),t.jsx(B,{size:"small",onClick:()=>pe(s),sx:{position:"absolute",top:4,right:4,bgcolor:"rgba(0,0,0,0.5)",color:"#FFFFFF",width:20,height:20,"&:hover":{bgcolor:"rgba(0,0,0,0.7)"}},children:"Ã—"})]},s))})}),t.jsx(n,{sx:{p:2,borderTop:"1px solid #E5E7EB"},children:t.jsxs(d,{direction:"row",spacing:1,useFlexGap:!0,alignItems:"flex-end",children:[t.jsx("input",{type:"file",ref:E,onChange:he,accept:"image/*,video/*",multiple:!0,style:{display:"none"}}),t.jsx(B,{onClick:()=>E.current?.click(),sx:{border:"1px solid #E5E7EB",borderRadius:2,width:40,height:40,color:"#717171","&:hover":{bgcolor:"#F9FAFB",borderColor:"#AD542D"}},children:t.jsx(ve,{})}),t.jsx(We,{fullWidth:!0,placeholder:i("chat.type_placeholder"),value:b,onChange:e=>Y(e.target.value),onKeyPress:ue,multiline:!0,maxRows:4,size:"small",sx:{"& .MuiOutlinedInput-root":{borderRadius:2,bgcolor:"#FFFFFF","& fieldset":{borderColor:"#E5E7EB"}}}}),t.jsx(T,{variant:"contained",onClick:()=>void Z(),disabled:de||!b.trim()&&F.length===0,sx:{bgcolor:"#AD542D",borderRadius:2,minWidth:48,height:40,"&:hover":{bgcolor:"#78381C"},"&:disabled":{bgcolor:"#E5E7EB",color:"#9CA3AF"}},children:t.jsx(oe,{})})]})})]}):t.jsx(L,{elevation:0,sx:{border:"1px solid #E5E7EB",borderRadius:2,height:"calc(100vh - 250px)",display:"flex",alignItems:"center",justifyContent:"center"},children:t.jsxs(n,{sx:{textAlign:"center"},children:[t.jsx(n,{sx:{width:80,height:80,borderRadius:"50%",border:"2px solid #E5E7EB",display:"flex",alignItems:"center",justifyContent:"center",mx:"auto",mb:2},children:t.jsx(oe,{sx:{fontSize:40,color:"#9CA3AF"}})}),t.jsx(l,{variant:"h6",sx:{color:"#6B7280",mb:1},children:i("chat.select_conversation")}),t.jsx(l,{variant:"body2",sx:{color:"#9CA3AF"},children:i("chat.select_conversation_sub")})]})})})]})]})}),t.jsx(Fe,{}),t.jsxs(ke,{open:k,onClose:()=>{y(!1),C(null)},maxWidth:"sm",fullWidth:!0,PaperProps:{sx:{borderRadius:2,maxHeight:"80vh"}},children:[t.jsxs(Pe,{sx:{pb:1,display:"flex",justifyContent:"space-between",alignItems:"center"},children:[t.jsx(l,{variant:"h6",sx:{fontWeight:700,color:"#222222"},children:i("chat.start_conversation")}),t.jsx(B,{onClick:()=>{y(!1),C(null)},sx:{color:"#717171"},children:t.jsx(Se,{})})]}),t.jsxs(_e,{sx:{p:0},children:[t.jsx(l,{variant:"body2",sx:{px:3,pb:2,color:"#717171"},children:i("chat.select_property")}),t.jsx(n,{sx:{maxHeight:"50vh",overflowY:"auto"},children:le?t.jsx(n,{sx:{py:4,textAlign:"center"},children:t.jsx(l,{variant:"body2",sx:{color:"#717171"},children:i("chat.loading")})}):$.length===0?t.jsx(n,{sx:{py:4,textAlign:"center"},children:t.jsx(l,{variant:"body2",sx:{color:"#717171"},children:i("chat.no_properties")})}):$.map(e=>t.jsx(n,{onClick:()=>C(e.propertyId),sx:{px:3,py:2,cursor:"pointer",bgcolor:v===e.propertyId?"#FFF5F7":"transparent",borderBottom:"1px solid #E5E7EB","&:hover":{bgcolor:v===e.propertyId?"#FFF5F7":"#F9FAFB"}},children:t.jsxs(d,{direction:"row",spacing:2,useFlexGap:!0,alignItems:"center",children:[t.jsx(R,{src:e.hostAvatar??void 0,sx:{bgcolor:"#AD542D",width:40,height:40},children:e.hostName.charAt(0)}),t.jsxs(n,{sx:{flex:1,minWidth:0},children:[t.jsx(l,{variant:"subtitle2",sx:{fontWeight:700,color:"#222222",mb:.5},children:e.hostName}),t.jsx(l,{variant:"body2",sx:{color:"#717171",fontSize:"0.875rem"},noWrap:!0,children:e.property})]})]})},e.propertyId))})]}),t.jsxs(He,{sx:{p:2,borderTop:"1px solid #E5E7EB"},children:[t.jsx(T,{onClick:()=>{y(!1),C(null)},sx:{color:"#717171",textTransform:"none",fontWeight:600},children:i("chat.cancel")}),t.jsx(T,{onClick:()=>void me(),disabled:!v||S,variant:"contained",sx:{bgcolor:"#AD542D",textTransform:"none",fontWeight:700,borderRadius:2,px:3,"&:hover":{bgcolor:"#78381C"},"&:disabled":{bgcolor:"#E5E7EB",color:"#9CA3AF"}},children:i(S?"chat.loading":"chat.start")})]})]})]})}export{it as default};
