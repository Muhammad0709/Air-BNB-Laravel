import{b as ue,r as n,a as te,j as e,H as fe}from"./app-D8edOWXn.js";import{N as je,F as be}from"./Footer-BnJykdy7.js";import{u as Fe}from"./use-language-DtKZJM4y.js";import{A as ye,S as se}from"./AttachFile-xFG8MVQy.js";import{a as re,b as oe,V as ve,c as we}from"./chatApi-Cq8LLC8n.js";import{M as Ce}from"./MoreVert-DFqSK2nv.js";import{A as Ee}from"./Add-Ze85R7No.js";import{C as Ae}from"./Close-ZvlGfhoA.js";import{B as i,T as a}from"./Box-C2PF00jf.js";import{C as De}from"./Container-B9bZszYJ.js";import{R as Se,C as ie}from"./Row-V3psX_1Y.js";import{C as W,a as ne}from"./CardContent-Dv-hAY9L.js";import{B as E,S as h,M as Ie,P as Me}from"./Stack-26joxvls.js";import{A as k,I as A,M as P}from"./KeyboardArrowDown-s2i05HpT.js";import{T as Te}from"./TextField-D8p6qWxF.js";import{D as Be,a as Re,b as We,c as ke}from"./DialogTitle-BGKT9-K3.js";/* empty css            */import"./useFormControl-B4piLBUM.js";function _(l){return{...l,sender:l.sender==="user"?"customer":"host",timestamp:l.timestamp}}function tt(){const{t:l}=Fe(),{url:D,props:S}=ue(),z=n.useMemo(()=>{const t=D.includes("?")?D.split("?")[1]:"";return new URLSearchParams(t)},[D]),H=n.useRef(null),v=n.useRef(null),[d,w]=n.useState(null),[f,L]=n.useState(""),[j,I]=n.useState([]),[N,O]=n.useState({}),[M,b]=n.useState(!1),[F,y]=n.useState(null),[U,V]=n.useState([]),[ae,Y]=n.useState(!1),[K,$]=n.useState(!1),[le,q]=n.useState(!1),[ce,G]=n.useState(!1),T=n.useMemo(()=>(Array.isArray(S.conversations)?S.conversations:[]).map(r=>({...r,messages:[]})),[S.conversations]),[u,g]=n.useState(T);n.useEffect(()=>{g(t=>{const r=new Map(t.map(o=>[o.id,o]));for(const o of T)if(!r.has(o.id))r.set(o.id,{...o,messages:[]});else{const s=r.get(o.id);r.set(o.id,{...o,messages:s.messages})}return Array.from(r.values()).sort((o,s)=>new Date(s.lastMessageTime).getTime()-new Date(o.lastMessageTime).getTime())})},[T]),n.useEffect(()=>{M&&(Y(!0),re("/api/messages/properties-to-message").then(t=>V(t.data?.properties??[])).catch(()=>V([])).finally(()=>Y(!1)))},[M]);const p=u.find(t=>t.id===d),J=n.useCallback(()=>{H.current?.scrollIntoView({behavior:"smooth"})},[]),B=n.useCallback((t,r)=>{g(o=>o.map(s=>s.id!==t||s.messages.some(x=>x.id===r.id)?s:{...s,messages:[...s.messages,r]}))},[]);n.useEffect(()=>{const t=z.get("property_id"),r=t?parseInt(t,10):null;if(!r)return;const o=u.find(s=>s.propertyId===r);if(o){w(o.id),te.visit("/chat");return}oe("/api/messages/conversations",{property_id:r}).then(s=>{const x=s.data?.conversation;if(x){const c={...x,messages:[]};g(m=>m.find(R=>R.id===c.id)?m:[c,...m].sort((R,ge)=>new Date(ge.lastMessageTime).getTime()-new Date(R.lastMessageTime).getTime())),w(x.id)}}).catch(()=>{}).finally(()=>te.visit("/chat"))},[z,u]),n.useEffect(()=>{if(!d)return;const t=u.find(r=>r.id===d);t&&t.messages.length>0||(q(!0),re(`/api/messages/conversations/${d}`).then(r=>{const o=(r.data.messages??[]).map(s=>_({id:s.id,text:s.text,sender:s.sender,timestamp:s.timestamp,read:s.read,files:s.files??null}));g(s=>s.map(x=>x.id===d?{...x,messages:o}:x))}).catch(()=>{}).finally(()=>q(!1)))},[d,u]),n.useEffect(()=>{if(!d||typeof window>"u"||!window.Echo)return;const t=`conversation.${d}`,r=window.Echo,o=x=>{const c=x;!c||c.id==null||B(d,_({id:c.id,text:c.text,sender:c.sender??"host",timestamp:c.timestamp??new Date().toISOString(),read:c.read??!1,files:c.files??null}))},s=r.private(t);return s.listen(".message.sent",o),()=>{try{s.leave?.()}catch{}}},[d,B]),n.useEffect(()=>{p&&J()},[p?.messages,J,p]);const de=t=>{if(t.target.files){const r=Array.from(t.target.files);I(o=>[...o,...r])}},xe=t=>{I(r=>r.filter((o,s)=>s!==t))},Q=async()=>{if(!f.trim()&&j.length===0||!d)return;G(!0);const t=new FormData;t.append("message",f.trim()),j.forEach(r=>t.append("files[]",r));try{const o=(await we(`/api/messages/conversations/${d}/messages`,t)).data?.message;if(o){const s=_({id:o.id,text:o.text,sender:"user",timestamp:o.timestamp??new Date().toISOString(),read:o.read,files:o.files??null});B(d,s);const x=f.trim()||"";g(c=>c.map(m=>m.id===d?{...m,lastMessage:x,lastMessageTime:new Date().toISOString()}:m))}L(""),I([]),v.current&&(v.current.value="")}finally{G(!1)}},he=t=>{t.key==="Enter"&&!t.shiftKey&&(t.preventDefault(),Q())},X=t=>(typeof t=="string"?new Date(t):t).toLocaleTimeString("en-US",{hour:"2-digit",minute:"2-digit"}),Z=t=>{const r=typeof t=="string"?new Date(t):t,o=new Date,s=new Date(o);return s.setDate(s.getDate()-1),r.toDateString()===o.toDateString()?"Today":r.toDateString()===s.toDateString()?"Yesterday":r.toLocaleDateString("en-US",{month:"short",day:"numeric"})},pe=(t,r)=>{O(o=>({...o,[t]:r.currentTarget}))},C=t=>{O(r=>({...r,[t]:null}))},me=async()=>{if(F){$(!0);try{const r=(await oe("/api/messages/conversations",{property_id:F})).data?.conversation;if(r){const o={...r,messages:[]};g(s=>s.find(c=>c.id===o.id)?s:[o,...s].sort((c,m)=>new Date(m.lastMessageTime).getTime()-new Date(c.lastMessageTime).getTime())),w(r.id)}b(!1),y(null)}finally{$(!1)}}},ee=t=>t.lastMessage.includes("image")||t.lastMessage.includes("video")?"":t.lastMessage;return e.jsxs(i,{children:[e.jsx(fe,{title:l("chat.messages")}),e.jsx(je,{}),e.jsx(i,{sx:{minHeight:"100vh",bgcolor:"#FFFFFF",py:4},children:e.jsxs(De,{children:[e.jsxs(i,{sx:{mb:4},children:[e.jsx(a,{variant:"h2",sx:{fontSize:"2.5rem",fontWeight:800,color:"#222222",mb:1},children:l("chat.messages")}),e.jsx(a,{variant:"body1",sx:{color:"#717171",fontSize:"1rem"},children:l("chat.chat_with_hosts")})]}),e.jsxs(Se,{children:[e.jsx(ie,{xs:12,md:4,lg:3,children:e.jsxs(W,{elevation:0,sx:{border:"1px solid #E5E7EB",borderRadius:2,height:"calc(100vh - 250px)",overflow:"hidden",display:"flex",flexDirection:"column"},children:[e.jsx(ne,{sx:{p:2},children:e.jsx(E,{variant:"contained",startIcon:e.jsx(Ee,{}),fullWidth:!0,onClick:()=>b(!0),sx:{bgcolor:"#AD542D",textTransform:"none",fontWeight:700,borderRadius:2,mb:2,py:1.5,"&:hover":{bgcolor:"#78381C"}},children:l("chat.start_conversation")})}),e.jsx(ne,{sx:{p:0,flex:1,overflowY:"auto"},children:u.map(t=>e.jsx(i,{onClick:()=>{w(t.id),g(r=>r.map(o=>o.id===t.id?{...o,unreadCount:0}:o))},sx:{p:2,borderBottom:"1px solid #E5E7EB",cursor:"pointer",bgcolor:d===t.id?"#FFF5F7":"transparent",position:"relative","&:hover":{bgcolor:d===t.id?"#FFF5F7":"#F9FAFB"}},children:e.jsxs(h,{direction:"row",spacing:2,alignItems:"flex-start",children:[e.jsx(k,{sx:{bgcolor:"#AD542D",width:48,height:48},children:t.hostName.charAt(0)}),e.jsxs(i,{sx:{flex:1,minWidth:0},children:[e.jsxs(h,{direction:"row",justifyContent:"space-between",alignItems:"center",sx:{mb:.5},children:[e.jsx(a,{variant:"subtitle2",sx:{fontWeight:700,color:"#222222"},children:t.hostName}),e.jsxs(h,{direction:"row",spacing:1,alignItems:"center",children:[e.jsx(a,{variant:"caption",sx:{color:"#9CA3AF"},children:Z(t.lastMessageTime)}),e.jsx(A,{size:"small",onClick:r=>{r.stopPropagation(),pe(t.id,r)},sx:{p:.5},children:e.jsx(Ce,{sx:{fontSize:18,color:"#9CA3AF"}})}),e.jsxs(Ie,{anchorEl:N[t.id],open:!!N[t.id],onClose:()=>C(t.id),children:[e.jsx(P,{onClick:()=>C(t.id),children:"Archive"}),e.jsx(P,{onClick:()=>C(t.id),children:"Delete"}),e.jsx(P,{onClick:()=>C(t.id),children:"Mute"})]})]})]}),e.jsxs(h,{direction:"row",justifyContent:"space-between",alignItems:"center",children:[ee(t)&&e.jsx(a,{variant:"body2",sx:{color:t.unreadCount>0?"#222222":"#717171",fontWeight:t.unreadCount>0?600:400,overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap",flex:1,mr:1},children:ee(t)}),t.unreadCount>0&&e.jsx(i,{sx:{bgcolor:"#AD542D",color:"#FFFFFF",borderRadius:"50%",width:20,height:20,display:"flex",alignItems:"center",justifyContent:"center",fontSize:"0.75rem",fontWeight:700},children:t.unreadCount})]})]})]})},t.id))})]})}),e.jsx(ie,{xs:12,md:8,lg:9,children:p?e.jsxs(W,{elevation:0,sx:{border:"1px solid #E5E7EB",borderRadius:2,height:"calc(100vh - 250px)",display:"flex",flexDirection:"column"},children:[e.jsx(i,{sx:{p:2,borderBottom:"1px solid #E5E7EB"},children:e.jsx(h,{direction:"row",spacing:2,alignItems:"center",justifyContent:"space-between",children:e.jsxs(h,{direction:"row",spacing:2,alignItems:"center",children:[e.jsx(k,{sx:{bgcolor:"#AD542D",width:40,height:40},children:p.hostName.charAt(0)}),e.jsxs(i,{children:[e.jsx(a,{variant:"subtitle1",sx:{fontWeight:700,color:"#222222"},children:p.hostName}),e.jsx(a,{variant:"caption",sx:{color:"#717171"},children:p.property})]})]})})}),e.jsxs(i,{sx:{flex:1,overflowY:"auto",p:2,bgcolor:"#F9FAFB"},children:[le?e.jsx(i,{sx:{textAlign:"center",py:4},children:e.jsx(a,{variant:"body2",sx:{color:"#717171"},children:l("chat.loading")})}):e.jsx(e.Fragment,{children:p.messages.map((t,r)=>{const o=r===0||new Date(t.timestamp).toDateString()!==new Date(p.messages[r-1].timestamp).toDateString();return e.jsxs(i,{children:[o&&e.jsx(i,{sx:{textAlign:"center",my:2},children:e.jsx(a,{variant:"caption",sx:{color:"#9CA3AF",bgcolor:"#F9FAFB",px:2,py:.5,borderRadius:1},children:Z(t.timestamp)})}),e.jsx(h,{direction:"row",justifyContent:t.sender==="customer"?"flex-end":"flex-start",sx:{mb:1.5},children:t.files&&t.files.length>0&&!t.text?e.jsxs(i,{sx:{maxWidth:"70%",position:"relative"},children:[e.jsx(h,{spacing:1,children:t.files.map(s=>e.jsx(i,{sx:{position:"relative"},children:s.type==="image"?e.jsx(i,{component:"img",src:s.url,alt:s.name,sx:{maxWidth:"100%",maxHeight:300,borderRadius:2,objectFit:"cover",cursor:"pointer",display:"block"},onClick:()=>window.open(s.url,"_blank")}):e.jsx(i,{sx:{borderRadius:2,overflow:"hidden",maxHeight:300},children:e.jsx("video",{src:s.url,style:{maxWidth:"100%",maxHeight:300,display:"block"},controls:!0})})},s.id))}),e.jsx(a,{variant:"caption",sx:{color:"#9CA3AF",fontSize:"0.7rem",display:"block",mt:.5,textAlign:t.sender==="customer"?"right":"left"},children:X(t.timestamp)})]}):e.jsxs(Me,{elevation:0,sx:{p:1.5,maxWidth:"70%",bgcolor:t.sender==="customer"?"#AD542D":"#FFFFFF",color:t.sender==="customer"?"#FFFFFF":"#222222",borderRadius:2,border:t.sender==="host"?"1px solid #E5E7EB":"none"},children:[t.files&&t.files.length>0&&e.jsx(h,{spacing:1,sx:{mb:t.text?1:0},children:t.files.map(s=>e.jsx(i,{children:s.type==="image"?e.jsx(i,{component:"img",src:s.url,alt:s.name,sx:{maxWidth:"100%",maxHeight:300,borderRadius:1,objectFit:"cover",cursor:"pointer"},onClick:()=>window.open(s.url,"_blank")}):e.jsx(i,{sx:{position:"relative",bgcolor:"rgba(0,0,0,0.5)",borderRadius:1,overflow:"hidden",minHeight:200,display:"flex",alignItems:"center",justifyContent:"center"},children:e.jsx("video",{src:s.url,style:{maxWidth:"100%",maxHeight:300,borderRadius:4},controls:!0})})},s.id))}),t.text&&e.jsx(a,{variant:"body2",sx:{mb:.5},children:t.text}),e.jsx(a,{variant:"caption",sx:{color:t.sender==="customer"?"rgba(255,255,255,0.7)":"#9CA3AF",fontSize:"0.7rem"},children:X(t.timestamp)})]})})]},t.id)})}),e.jsx("div",{ref:H})]}),j.length>0&&e.jsx(i,{sx:{p:2,borderTop:"1px solid #E5E7EB",bgcolor:"#FFFFFF"},children:e.jsx(h,{direction:"row",spacing:1,sx:{flexWrap:"wrap",gap:1},children:j.map((t,r)=>e.jsxs(i,{sx:{position:"relative",border:"1px solid #E5E7EB",borderRadius:1,overflow:"hidden",width:80,height:80},children:[t.type.startsWith("image/")?e.jsx(i,{component:"img",src:URL.createObjectURL(t),alt:t.name,sx:{width:"100%",height:"100%",objectFit:"cover"}}):e.jsx(i,{sx:{width:"100%",height:"100%",display:"flex",alignItems:"center",justifyContent:"center",bgcolor:"#F9FAFB"},children:e.jsx(ve,{sx:{fontSize:32,color:"#717171"}})}),e.jsx(A,{size:"small",onClick:()=>xe(r),sx:{position:"absolute",top:4,right:4,bgcolor:"rgba(0,0,0,0.5)",color:"#FFFFFF",width:20,height:20,"&:hover":{bgcolor:"rgba(0,0,0,0.7)"}},children:"Ã—"})]},r))})}),e.jsx(i,{sx:{p:2,borderTop:"1px solid #E5E7EB"},children:e.jsxs(h,{direction:"row",spacing:1,alignItems:"flex-end",children:[e.jsx("input",{type:"file",ref:v,onChange:de,accept:"image/*,video/*",multiple:!0,style:{display:"none"}}),e.jsx(A,{onClick:()=>v.current?.click(),sx:{border:"1px solid #E5E7EB",borderRadius:2,width:40,height:40,color:"#717171","&:hover":{bgcolor:"#F9FAFB",borderColor:"#AD542D"}},children:e.jsx(ye,{})}),e.jsx(Te,{fullWidth:!0,placeholder:l("chat.type_placeholder"),value:f,onChange:t=>L(t.target.value),onKeyPress:he,multiline:!0,maxRows:4,size:"small",sx:{"& .MuiOutlinedInput-root":{borderRadius:2,bgcolor:"#FFFFFF","& fieldset":{borderColor:"#E5E7EB"}}}}),e.jsx(E,{variant:"contained",onClick:()=>void Q(),disabled:ce||!f.trim()&&j.length===0,sx:{bgcolor:"#AD542D",borderRadius:2,minWidth:48,height:40,"&:hover":{bgcolor:"#78381C"},"&:disabled":{bgcolor:"#E5E7EB",color:"#9CA3AF"}},children:e.jsx(se,{})})]})})]}):e.jsx(W,{elevation:0,sx:{border:"1px solid #E5E7EB",borderRadius:2,height:"calc(100vh - 250px)",display:"flex",alignItems:"center",justifyContent:"center"},children:e.jsxs(i,{sx:{textAlign:"center"},children:[e.jsx(i,{sx:{width:80,height:80,borderRadius:"50%",border:"2px solid #E5E7EB",display:"flex",alignItems:"center",justifyContent:"center",mx:"auto",mb:2},children:e.jsx(se,{sx:{fontSize:40,color:"#9CA3AF"}})}),e.jsx(a,{variant:"h6",sx:{color:"#6B7280",mb:1},children:l("chat.select_conversation")}),e.jsx(a,{variant:"body2",sx:{color:"#9CA3AF"},children:l("chat.select_conversation_sub")})]})})})]})]})}),e.jsx(be,{}),e.jsxs(Be,{open:M,onClose:()=>{b(!1),y(null)},maxWidth:"sm",fullWidth:!0,PaperProps:{sx:{borderRadius:2,maxHeight:"80vh"}},children:[e.jsxs(Re,{sx:{pb:1,display:"flex",justifyContent:"space-between",alignItems:"center"},children:[e.jsx(a,{variant:"h6",sx:{fontWeight:700,color:"#222222"},children:l("chat.start_conversation")}),e.jsx(A,{onClick:()=>{b(!1),y(null)},sx:{color:"#717171"},children:e.jsx(Ae,{})})]}),e.jsxs(We,{sx:{p:0},children:[e.jsx(a,{variant:"body2",sx:{px:3,pb:2,color:"#717171"},children:l("chat.select_property")}),e.jsx(i,{sx:{maxHeight:"50vh",overflowY:"auto"},children:ae?e.jsx(i,{sx:{py:4,textAlign:"center"},children:e.jsx(a,{variant:"body2",sx:{color:"#717171"},children:l("chat.loading")})}):U.length===0?e.jsx(i,{sx:{py:4,textAlign:"center"},children:e.jsx(a,{variant:"body2",sx:{color:"#717171"},children:l("chat.no_properties")})}):U.map(t=>e.jsx(i,{onClick:()=>y(t.propertyId),sx:{px:3,py:2,cursor:"pointer",bgcolor:F===t.propertyId?"#FFF5F7":"transparent",borderBottom:"1px solid #E5E7EB","&:hover":{bgcolor:F===t.propertyId?"#FFF5F7":"#F9FAFB"}},children:e.jsxs(h,{direction:"row",spacing:2,alignItems:"center",children:[e.jsx(k,{src:t.hostAvatar??void 0,sx:{bgcolor:"#AD542D",width:40,height:40},children:t.hostName.charAt(0)}),e.jsxs(i,{sx:{flex:1,minWidth:0},children:[e.jsx(a,{variant:"subtitle2",sx:{fontWeight:700,color:"#222222",mb:.5},children:t.hostName}),e.jsx(a,{variant:"body2",sx:{color:"#717171",fontSize:"0.875rem"},noWrap:!0,children:t.property})]})]})},t.propertyId))})]}),e.jsxs(ke,{sx:{p:2,borderTop:"1px solid #E5E7EB"},children:[e.jsx(E,{onClick:()=>{b(!1),y(null)},sx:{color:"#717171",textTransform:"none",fontWeight:600},children:l("chat.cancel")}),e.jsx(E,{onClick:()=>void me(),disabled:!F||K,variant:"contained",sx:{bgcolor:"#AD542D",textTransform:"none",fontWeight:700,borderRadius:2,px:3,"&:hover":{bgcolor:"#78381C"},"&:disabled":{bgcolor:"#E5E7EB",color:"#9CA3AF"}},children:l(K?"chat.loading":"chat.start")})]})]})]})}export{tt as default};
