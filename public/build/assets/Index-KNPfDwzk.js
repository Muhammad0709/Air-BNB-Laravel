import{b as re,r as n,j as t,H as ie}from"./app-B_RmO_HU.js";import{H as oe}from"./HostLayout-8dhqJQwH.js";import{A as ne,S as _}from"./AttachFile-j1gwRB0C.js";import{a as ae,V as le,c as de}from"./chatApi-CuG1Hgwn.js";import{M as ce}from"./MoreVert-Di51Ixdk.js";import{A as xe}from"./Add-DsrpLWXg.js";import{C as he}from"./Close-C_nLVBxE.js";import{R as me,C as J}from"./Row-B3ptccXC.js";import{C as B,a as K}from"./CardContent-DKXkD2RF.js";import{B as y,S as d,M as pe,a as I,P as ue}from"./ArrowDropDown-DGzKek7n.js";import{B as o,T as l}from"./use-language-3LGvdBiG.js";import{A as R,I as v}from"./KeyboardArrowDown--GCg5Byw.js";import{T as ge}from"./TextField-efstak88.js";import{D as fe,a as je,b as be,c as Fe}from"./DialogTitle-4fFCGiNF.js";/* empty css            */import"./Logout-BXTBUTU1.js";import"./Hotel-VTPHD3KT.js";import"./Message-CsrsorU7.js";import"./Container-k9eFsD7X.js";import"./useFormControl-C2TJA0L6.js";function T(m){return{...m,sender:m.sender==="user"?"customer":m.sender,timestamp:m.timestamp}}function Ge(){const{props:m}=re(),k=n.useRef(null),C=n.useRef(null),[a,E]=n.useState(null),[u,W]=n.useState(""),[g,A]=n.useState([]),[H,P]=n.useState({}),[$,f]=n.useState(!1),[j,b]=n.useState(null),[q,z]=n.useState(!1),[Q,L]=n.useState(!1),D=n.useMemo(()=>(Array.isArray(m.conversations)?m.conversations:[]).map(s=>({...s,messages:[]})),[m.conversations]),[F,p]=n.useState(D);n.useEffect(()=>{p(e=>{const s=new Map(e.map(i=>[i.id,i]));for(const i of D)s.has(i.id)?s.set(i.id,{...i,messages:s.get(i.id).messages}):s.set(i.id,{...i,messages:[]});return Array.from(s.values()).sort((i,r)=>new Date(r.lastMessageTime).getTime()-new Date(i.lastMessageTime).getTime())})},[D]);const[O]=n.useState([{id:1,name:"John Doe",email:"john.doe@example.com",avatar:""},{id:2,name:"Jane Smith",email:"jane.smith@example.com",avatar:""},{id:3,name:"Mike Johnson",email:"mike.johnson@example.com",avatar:""},{id:4,name:"Emily Davis",email:"emily.davis@example.com",avatar:""},{id:5,name:"Robert Wilson",email:"robert.wilson@example.com",avatar:""}]),h=F.find(e=>e.id===a),G=n.useCallback(()=>{k.current?.scrollIntoView({behavior:"smooth"})},[]),S=n.useCallback((e,s)=>{p(i=>i.map(r=>r.id!==e||r.messages.some(c=>c.id===s.id)?r:{...r,messages:[...r.messages,s]}))},[]);n.useEffect(()=>{if(!a)return;const e=F.find(s=>s.id===a);e&&e.messages.length>0||(z(!0),ae(`/api/host/chat/conversations/${a}`).then(s=>{const i=(s.data.messages??[]).map(r=>T({id:r.id,text:r.text,sender:r.sender,timestamp:r.timestamp,read:r.read,files:r.files??null}));p(r=>r.map(c=>c.id===a?{...c,messages:i}:c))}).catch(()=>{}).finally(()=>z(!1)))},[a,F]),n.useEffect(()=>{if(!a||typeof window>"u"||!window.Echo)return;const e=`conversation.${a}`,s=window.Echo,i=c=>{const x=c;!x||x.id==null||S(a,T({id:x.id,text:x.text,sender:x.sender??"user",timestamp:x.timestamp??new Date().toISOString(),read:x.read??!1,files:x.files??null}))},r=s.private(e);return r.listen(".message.sent",i),()=>{try{r.leave?.()}catch{}}},[a,S]),n.useEffect(()=>{h&&G()},[h?.messages,G,h]);const X=e=>{if(e.target.files){const s=Array.from(e.target.files);A(i=>[...i,...s])}},Z=e=>{A(s=>s.filter((i,r)=>r!==e))},N=async()=>{if(!u.trim()&&g.length===0||!a)return;L(!0);const e=new FormData;e.append("message",u.trim()),g.forEach(s=>e.append("files[]",s));try{const i=(await de(`/api/host/chat/conversations/${a}/messages`,e)).data?.message;if(i){const r=T({id:i.id,text:i.text,sender:"host",timestamp:i.timestamp??new Date().toISOString(),read:i.read,files:i.files??null});S(a,r);const c=u.trim()||"";p(x=>x.map(M=>M.id===a?{...M,lastMessage:c,lastMessageTime:new Date().toISOString()}:M))}W(""),A([]),C.current&&(C.current.value="")}finally{L(!1)}},ee=e=>{e.key==="Enter"&&!e.shiftKey&&(e.preventDefault(),N())},U=e=>(typeof e=="string"?new Date(e):e).toLocaleTimeString("en-US",{hour:"2-digit",minute:"2-digit"}),V=e=>{const s=typeof e=="string"?new Date(e):e,i=new Date,r=new Date(i);return r.setDate(r.getDate()-1),s.toDateString()===i.toDateString()?"Today":s.toDateString()===r.toDateString()?"Yesterday":s.toLocaleDateString("en-US",{month:"short",day:"numeric"})},te=(e,s)=>{P(i=>({...i,[e]:s.currentTarget}))},w=e=>{P(s=>({...s,[e]:null}))},se=e=>{const s=O.find(i=>i.id===e);if(s){const i=F.find(r=>r.customerName===s.name);if(i)E(i.id);else{const r={id:Date.now(),customerName:s.name,customerAvatar:s.avatar,property:"New Property",lastMessage:"",lastMessageTime:new Date().toISOString(),unreadCount:0,messages:[]};p(c=>[r,...c]),E(r.id)}}f(!1),b(null)},Y=e=>e.lastMessage.includes("image")||e.lastMessage.includes("video")?"":e.lastMessage;return t.jsxs(t.Fragment,{children:[t.jsx(ie,{title:"Messages"}),t.jsxs(oe,{title:"Messages",children:[t.jsxs(me,{children:[t.jsx(J,{xs:12,md:4,lg:3,children:t.jsxs(B,{elevation:0,sx:{border:"1px solid #E5E7EB",borderRadius:2,height:"calc(100vh - 200px)",overflow:"hidden",display:"flex",flexDirection:"column"},children:[t.jsx(K,{sx:{p:2},children:t.jsx(y,{variant:"contained",startIcon:t.jsx(xe,{}),fullWidth:!0,onClick:()=>f(!0),sx:{bgcolor:"#AD542D",textTransform:"none",fontWeight:700,borderRadius:2,mb:2,py:1.5,"&:hover":{bgcolor:"#78381C"}},children:"Start Conversation"})}),t.jsx(K,{sx:{p:0,flex:1,overflowY:"auto"},children:F.map(e=>t.jsx(o,{onClick:()=>{E(e.id),p(s=>s.map(i=>i.id===e.id?{...i,unreadCount:0}:i))},sx:{p:2,borderBottom:"1px solid #E5E7EB",cursor:"pointer",bgcolor:a===e.id?"#FFF5F7":"transparent",position:"relative","&:hover":{bgcolor:a===e.id?"#FFF5F7":"#F9FAFB"}},children:t.jsxs(d,{direction:"row",spacing:2,useFlexGap:!0,alignItems:"flex-start",children:[t.jsx(R,{sx:{bgcolor:"#AD542D",width:48,height:48},children:e.customerName.charAt(0)}),t.jsxs(o,{sx:{flex:1,minWidth:0},children:[t.jsxs(d,{direction:"row",justifyContent:"space-between",alignItems:"center",sx:{mb:.5},children:[t.jsx(l,{variant:"subtitle2",sx:{fontWeight:700,color:"#222222"},children:e.customerName}),t.jsxs(d,{direction:"row",spacing:1,useFlexGap:!0,alignItems:"center",children:[t.jsx(l,{variant:"caption",sx:{color:"#9CA3AF"},children:V(e.lastMessageTime)}),t.jsx(v,{size:"small",onClick:s=>{s.stopPropagation(),te(e.id,s)},sx:{p:.5},children:t.jsx(ce,{sx:{fontSize:18,color:"#9CA3AF"}})}),t.jsxs(pe,{anchorEl:H[e.id],open:!!H[e.id],onClose:()=>w(e.id),children:[t.jsx(I,{onClick:()=>w(e.id),children:"Archive"}),t.jsx(I,{onClick:()=>w(e.id),children:"Delete"}),t.jsx(I,{onClick:()=>w(e.id),children:"Mute"})]})]})]}),t.jsxs(d,{direction:"row",justifyContent:"space-between",alignItems:"center",children:[Y(e)&&t.jsx(l,{variant:"body2",sx:{color:e.unreadCount>0?"#222222":"#717171",fontWeight:e.unreadCount>0?600:400,overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap",flex:1,marginInlineEnd:1},children:Y(e)}),e.unreadCount>0&&t.jsx(o,{sx:{bgcolor:"#AD542D",color:"#FFFFFF",borderRadius:"50%",width:20,height:20,display:"flex",alignItems:"center",justifyContent:"center",fontSize:"0.75rem",fontWeight:700},children:e.unreadCount})]})]})]})},e.id))})]})}),t.jsx(J,{xs:12,md:8,lg:9,children:h?t.jsxs(B,{elevation:0,sx:{border:"1px solid #E5E7EB",borderRadius:2,height:"calc(100vh - 200px)",display:"flex",flexDirection:"column"},children:[t.jsx(o,{sx:{p:2,borderBottom:"1px solid #E5E7EB"},children:t.jsx(d,{direction:"row",spacing:2,useFlexGap:!0,alignItems:"center",justifyContent:"space-between",children:t.jsxs(d,{direction:"row",spacing:2,useFlexGap:!0,alignItems:"center",children:[t.jsx(R,{sx:{bgcolor:"#AD542D",width:40,height:40},children:h.customerName.charAt(0)}),t.jsxs(o,{children:[t.jsx(l,{variant:"subtitle1",sx:{fontWeight:700,color:"#222222"},children:h.customerName}),t.jsx(l,{variant:"caption",sx:{color:"#717171"},children:h.property})]})]})})}),t.jsxs(o,{sx:{flex:1,overflowY:"auto",p:2,bgcolor:"#F9FAFB"},children:[q?t.jsx(o,{sx:{textAlign:"center",py:4},children:t.jsx(l,{variant:"body2",sx:{color:"#717171"},children:"Loading messages…"})}):t.jsx(t.Fragment,{children:h.messages.map((e,s)=>{const i=s===0||new Date(e.timestamp).toDateString()!==new Date(h.messages[s-1].timestamp).toDateString();return t.jsxs(o,{children:[i&&t.jsx(o,{sx:{textAlign:"center",my:2},children:t.jsx(l,{variant:"caption",sx:{color:"#9CA3AF",bgcolor:"#F9FAFB",px:2,py:.5,borderRadius:1},children:V(e.timestamp)})}),t.jsx(d,{direction:"row",justifyContent:e.sender==="host"?"flex-end":"flex-start",sx:{mb:1.5},children:e.files&&e.files.length>0&&!e.text?t.jsxs(o,{sx:{maxWidth:"70%",position:"relative"},children:[t.jsx(d,{spacing:1,children:e.files.map(r=>t.jsx(o,{sx:{position:"relative"},children:r.type==="image"?t.jsx(o,{component:"img",src:r.url,alt:r.name,sx:{maxWidth:"100%",maxHeight:300,borderRadius:2,objectFit:"cover",cursor:"pointer",display:"block"},onClick:()=>window.open(r.url,"_blank")}):t.jsx(o,{sx:{borderRadius:2,overflow:"hidden",maxHeight:300},children:t.jsx("video",{src:r.url,style:{maxWidth:"100%",maxHeight:300,display:"block"},controls:!0})})},r.id))}),t.jsx(l,{variant:"caption",sx:{color:"#9CA3AF",fontSize:"0.7rem",display:"block",mt:.5,textAlign:e.sender==="host"?"right":"left"},children:U(e.timestamp)})]}):t.jsxs(ue,{elevation:0,sx:{p:1.5,maxWidth:"70%",bgcolor:e.sender==="host"?"#AD542D":"#FFFFFF",color:e.sender==="host"?"#FFFFFF":"#222222",borderRadius:2,border:e.sender==="customer"?"1px solid #E5E7EB":"none"},children:[e.files&&e.files.length>0&&t.jsx(d,{spacing:1,sx:{mb:e.text?1:0},children:e.files.map(r=>t.jsx(o,{children:r.type==="image"?t.jsx(o,{component:"img",src:r.url,alt:r.name,sx:{maxWidth:"100%",maxHeight:300,borderRadius:1,objectFit:"cover",cursor:"pointer"},onClick:()=>window.open(r.url,"_blank")}):t.jsx(o,{sx:{position:"relative",bgcolor:"rgba(0,0,0,0.5)",borderRadius:1,overflow:"hidden",minHeight:200,display:"flex",alignItems:"center",justifyContent:"center"},children:t.jsx("video",{src:r.url,style:{maxWidth:"100%",maxHeight:300,borderRadius:4},controls:!0})})},r.id))}),e.text&&t.jsx(l,{variant:"body2",sx:{mb:.5},children:e.text}),t.jsx(l,{variant:"caption",sx:{color:e.sender==="host"?"rgba(255,255,255,0.7)":"#9CA3AF",fontSize:"0.7rem"},children:U(e.timestamp)})]})})]},e.id)})}),t.jsx("div",{ref:k})]}),g.length>0&&t.jsx(o,{sx:{p:2,borderTop:"1px solid #E5E7EB",bgcolor:"#FFFFFF"},children:t.jsx(d,{direction:"row",spacing:1,useFlexGap:!0,sx:{flexWrap:"wrap",gap:1},children:g.map((e,s)=>t.jsxs(o,{sx:{position:"relative",border:"1px solid #E5E7EB",borderRadius:1,overflow:"hidden",width:80,height:80},children:[e.type.startsWith("image/")?t.jsx(o,{component:"img",src:URL.createObjectURL(e),alt:e.name,sx:{width:"100%",height:"100%",objectFit:"cover"}}):t.jsx(o,{sx:{width:"100%",height:"100%",display:"flex",alignItems:"center",justifyContent:"center",bgcolor:"#F9FAFB"},children:t.jsx(le,{sx:{fontSize:32,color:"#717171"}})}),t.jsx(v,{size:"small",onClick:()=>Z(s),sx:{position:"absolute",top:4,right:4,bgcolor:"rgba(0,0,0,0.5)",color:"#FFFFFF",width:20,height:20,"&:hover":{bgcolor:"rgba(0,0,0,0.7)"}},children:"×"})]},s))})}),t.jsx(o,{sx:{p:2,borderTop:"1px solid #E5E7EB"},children:t.jsxs(d,{direction:"row",spacing:1,useFlexGap:!0,alignItems:"flex-end",children:[t.jsx("input",{type:"file",ref:C,onChange:X,accept:"image/*,video/*",multiple:!0,style:{display:"none"}}),t.jsx(v,{onClick:()=>C.current?.click(),sx:{border:"1px solid #E5E7EB",borderRadius:2,width:40,height:40,color:"#717171","&:hover":{bgcolor:"#F9FAFB",borderColor:"#AD542D"}},children:t.jsx(ne,{})}),t.jsx(ge,{fullWidth:!0,placeholder:"Type a message...",value:u,onChange:e=>W(e.target.value),onKeyPress:ee,multiline:!0,maxRows:4,size:"small",sx:{"& .MuiOutlinedInput-root":{borderRadius:2,bgcolor:"#FFFFFF","& fieldset":{borderColor:"#E5E7EB"}}}}),t.jsx(y,{variant:"contained",onClick:()=>void N(),disabled:Q||!u.trim()&&g.length===0,sx:{bgcolor:"#AD542D",borderRadius:2,minWidth:48,height:40,"&:hover":{bgcolor:"#78381C"},"&:disabled":{bgcolor:"#E5E7EB",color:"#9CA3AF"}},children:t.jsx(_,{})})]})})]}):t.jsx(B,{elevation:0,sx:{border:"1px solid #E5E7EB",borderRadius:2,height:"calc(100vh - 200px)",display:"flex",alignItems:"center",justifyContent:"center"},children:t.jsxs(o,{sx:{textAlign:"center"},children:[t.jsx(o,{sx:{width:80,height:80,borderRadius:"50%",border:"2px solid #E5E7EB",display:"flex",alignItems:"center",justifyContent:"center",mx:"auto",mb:2},children:t.jsx(_,{sx:{fontSize:40,color:"#9CA3AF"}})}),t.jsx(l,{variant:"h6",sx:{color:"#6B7280",mb:1},children:"Select a conversation"}),t.jsx(l,{variant:"body2",sx:{color:"#9CA3AF"},children:"Choose a conversation from the list to start messaging, or create a new one."})]})})})]}),t.jsxs(fe,{open:$,onClose:()=>{f(!1),b(null)},maxWidth:"sm",fullWidth:!0,PaperProps:{sx:{borderRadius:2,maxHeight:"80vh"}},children:[t.jsxs(je,{sx:{pb:1,display:"flex",justifyContent:"space-between",alignItems:"center"},children:[t.jsx(l,{variant:"h6",sx:{fontWeight:700,color:"#222222"},children:"Start Conversation"}),t.jsx(v,{onClick:()=>{f(!1),b(null)},sx:{color:"#717171"},children:t.jsx(he,{})})]}),t.jsxs(be,{sx:{p:0},children:[t.jsx(l,{variant:"body2",sx:{px:3,pb:2,color:"#717171"},children:"Select Participants"}),t.jsx(o,{sx:{maxHeight:"50vh",overflowY:"auto"},children:O.map(e=>t.jsx(o,{onClick:()=>b(e.id),sx:{px:3,py:2,cursor:"pointer",bgcolor:j===e.id?"#FFF5F7":"transparent",borderBottom:"1px solid #E5E7EB","&:hover":{bgcolor:j===e.id?"#FFF5F7":"#F9FAFB"}},children:t.jsxs(d,{direction:"row",spacing:2,useFlexGap:!0,alignItems:"center",children:[t.jsx(R,{sx:{bgcolor:"#AD542D",width:40,height:40},children:e.name.charAt(0)}),t.jsxs(o,{sx:{flex:1},children:[t.jsx(l,{variant:"subtitle2",sx:{fontWeight:700,color:"#222222",mb:.5},children:e.name}),t.jsx(l,{variant:"body2",sx:{color:"#717171",fontSize:"0.875rem"},children:e.email})]})]})},e.id))})]}),t.jsxs(Fe,{sx:{p:2,borderTop:"1px solid #E5E7EB"},children:[t.jsx(y,{onClick:()=>{f(!1),b(null)},sx:{color:"#717171",textTransform:"none",fontWeight:600},children:"Cancel"}),t.jsx(y,{onClick:()=>j&&se(j),disabled:!j,variant:"contained",sx:{bgcolor:"#AD542D",textTransform:"none",fontWeight:700,borderRadius:2,px:3,"&:hover":{bgcolor:"#78381C"},"&:disabled":{bgcolor:"#E5E7EB",color:"#9CA3AF"}},children:"Start"})]})]})]})]})}export{Ge as default};
