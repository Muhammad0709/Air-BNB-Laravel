import{b as Fe,r as a,a as ie,j as t,H as ye}from"./app-GPvwMnjD.js";import{N as ve,F as Ce}from"./Footer-D3gxfHYq.js";import{u as we,B as n,T as l}from"./use-language-DFtL6GgK.js";import{A as Ae,S as ne}from"./AttachFile-CtIo1-Fx.js";import{a as ae,b as Ee,V as Se,c as De}from"./chatApi-DAlSU03H.js";import{M as Ie}from"./MoreVert-DDrTe-Te.js";import{A as Me}from"./Add-Qz69GAZD.js";import{C as Te}from"./Close-DxOvZVcn.js";import{A as Be}from"./ArrowBack-Ci0Euwbk.js";import{u as Re,B,S as d,I as E,M as ke,a as G,P as We}from"./ArrowDropDown-DnKwYjM7.js";import{u as Pe}from"./index-Djw-Leeq.js";import{C as _e}from"./Container-jBV_sa23.js";import{R as He,C as le}from"./Row-7DwCY0wW.js";import{C as O,a as ze}from"./CardContent-BIrKkGm3.js";import{A as R}from"./Menu-HEuTxDKX.js";import{T as Ne}from"./TextField-FgeJYGay.js";import{D as Le,a as Ge,b as Oe,c as Ue}from"./DialogTitle-WfsaDBFM.js";/* empty css            */import"./Message-laNH6aSc.js";function U(i){return{id:Number(i.id),text:i.text,sender:i.sender==="user"||i.sender==="customer"?"customer":"host",timestamp:i.timestamp??new Date().toISOString(),read:i.read??!1,files:i.files??null}}function Ye(i,m){return i?{...i,id:Number(i.id),propertyId:i.propertyId??m,messages:i.messages??[]}:null}function Ke(i){return(i.data?.messages??[]).map(U)}function Ve(i,m){return i.some(h=>h.id===m.id)?i:[m,...i].sort((h,S)=>new Date(S.lastMessageTime).getTime()-new Date(h.lastMessageTime).getTime())}function pt(){const{t:i}=we(),{url:m,props:h}=Fe(),S=a.useMemo(()=>{const e=m.includes("?")?m.split("?")[1]:"";return new URLSearchParams(e)},[m]),ce=a.useRef(null),Y=a.useRef(null),D=a.useRef(null),[c,j]=a.useState(null),[F,K]=a.useState(""),[y,k]=a.useState([]),[V,$]=a.useState({}),[W,v]=a.useState(!1),[C,w]=a.useState(null),f=a.useMemo(()=>Array.isArray(h.propertiesToMessage)?h.propertiesToMessage:[],[h.propertiesToMessage]),[q,P]=a.useState(f),[de,_]=a.useState(!1),[I,M]=a.useState(!1),[xe,J]=a.useState(!1),[he,Q]=a.useState(!1),X=a.useRef([]),pe=Re(),H=Pe(pe.breakpoints.down("md")),z=a.useMemo(()=>(Array.isArray(h.conversations)?h.conversations:[]).map(s=>({...s,messages:[]})),[h.conversations]),[g,b]=a.useState(z);X.current=g,a.useEffect(()=>{b(e=>{const s=new Map(e.map(o=>[o.id,o]));for(const o of z)if(!s.has(o.id))s.set(o.id,{...o,messages:[]});else{const r=s.get(o.id);s.set(o.id,{...o,messages:r.messages})}return Array.from(s.values()).sort((o,r)=>new Date(r.lastMessageTime).getTime()-new Date(o.lastMessageTime).getTime())})},[z]),a.useEffect(()=>{if(W){if(f.length>0){P(f),_(!1);return}_(!0),ae("/api/messages/properties-to-message").then(e=>P(e.data?.properties??[])).catch(()=>P([])).finally(()=>_(!1))}},[W,f]);const p=g.find(e=>e.id===c),Z=a.useMemo(()=>f.filter(e=>!g.some(s=>s.propertyId===e.propertyId)),[f,g]),A=a.useCallback(async e=>{const o=(await Ee("/api/messages/conversations",{property_id:e})).data?.conversation,r=Ye(o,e);return r?(b(x=>Ve(x,r)),setTimeout(()=>j(r.id),0),r.id):null},[]),ue=a.useCallback(async e=>{M(!0);try{await A(e)}catch{j(null)}finally{M(!1)}},[A]),ee=a.useCallback(()=>{const e=Y.current;e&&(e.scrollTop=e.scrollHeight)},[]),N=a.useCallback((e,s)=>{b(o=>o.map(r=>r.id!==e||r.messages.some(x=>x.id===s.id)?r:{...r,messages:[...r.messages,s]}))},[]);a.useEffect(()=>{const e=S.get("property_id"),s=e?parseInt(e,10):null;if(!s)return;const o=g.find(r=>r.propertyId===s);if(o){j(o.id),ie.visit("/chat");return}A(s).catch(()=>{}).finally(()=>ie.visit("/chat"))},[S,g,A]),a.useEffect(()=>{!c||X.current.find(s=>s.id===c)?.messages.length||(J(!0),ae(`/api/messages/conversations/${c}`).then(s=>{const o=Ke(s);b(r=>r.map(x=>x.id===c?{...x,messages:o}:x))}).catch(()=>{}).finally(()=>J(!1)))},[c]),a.useEffect(()=>{if(!c||typeof window>"u"||!window.Echo)return;const e=`conversation.${c}`,s=window.Echo,o=x=>{const u=x;!u||u.id==null||N(c,U({id:u.id,text:u.text,sender:u.sender??"host",timestamp:u.timestamp??new Date().toISOString(),read:u.read??!1,files:u.files??null}))},r=s.private(e);return r.listen(".message.sent",o),()=>{try{r.leave?.()}catch{}}},[c,N]),a.useEffect(()=>{p&&ee()},[p?.messages,ee,p]);const me=e=>{if(e.target.files){const s=Array.from(e.target.files);k(o=>[...o,...s])}},ge=e=>{k(s=>s.filter((o,r)=>r!==e))},te=async()=>{if(!F.trim()&&y.length===0||!c)return;Q(!0);const e=new FormData;e.append("message",F.trim()),y.forEach(s=>e.append("files[]",s));try{const o=(await De(`/api/messages/conversations/${c}/messages`,e)).data?.message;if(o){const r=U(o);N(c,r);const x=F.trim()||"";b(u=>u.map(L=>L.id===c?{...L,lastMessage:x,lastMessageTime:new Date().toISOString()}:L))}K(""),k([]),D.current&&(D.current.value="")}finally{Q(!1)}},fe=e=>{e.key==="Enter"&&!e.shiftKey&&(e.preventDefault(),te())},se=e=>(typeof e=="string"?new Date(e):e).toLocaleTimeString("en-US",{hour:"2-digit",minute:"2-digit"}),re=e=>{const s=typeof e=="string"?new Date(e):e,o=new Date,r=new Date(o);return r.setDate(r.getDate()-1),s.toDateString()===o.toDateString()?"Today":s.toDateString()===r.toDateString()?"Yesterday":s.toLocaleDateString("en-US",{month:"short",day:"numeric"})},be=(e,s)=>{$(o=>({...o,[e]:s.currentTarget}))},T=e=>{$(s=>({...s,[e]:null}))},je=async()=>{if(C){M(!0);try{await A(C),v(!1),w(null)}finally{M(!1)}}},oe=e=>e.lastMessage.includes("image")||e.lastMessage.includes("video")?"":e.lastMessage;return t.jsxs(n,{children:[t.jsx(ye,{title:i("chat.messages")}),t.jsx(ve,{}),t.jsx(n,{sx:{minHeight:"100vh",bgcolor:"#FFFFFF",py:4},children:t.jsxs(_e,{children:[t.jsxs(n,{sx:{mb:4},children:[t.jsx(l,{variant:"h2",sx:{fontSize:"2.5rem",fontWeight:800,color:"#222222",mb:1},children:i("chat.messages")}),t.jsx(l,{variant:"body1",sx:{color:"#717171",fontSize:"1rem"},children:i("chat.chat_with_hosts")})]}),t.jsxs(He,{children:[(!H||!c)&&t.jsx(le,{xs:12,md:4,lg:3,children:t.jsx(O,{elevation:0,sx:{border:"1px solid #E5E7EB",borderRadius:2,height:"calc(100vh - 250px)",overflow:"hidden",display:"flex",flexDirection:"column"},children:t.jsxs(ze,{sx:{p:0,flex:1,minHeight:0,overflowY:"scroll",display:"flex",flexDirection:"column"},children:[t.jsxs(n,{sx:{p:2,flex:"0 0 auto"},children:[t.jsx(B,{variant:"contained",startIcon:t.jsx(Me,{}),fullWidth:!0,onClick:()=>v(!0),sx:{bgcolor:"#AD542D",textTransform:"none",fontWeight:700,borderRadius:2,mb:2,py:1.5,"&:hover":{bgcolor:"#78381C"}},children:i("chat.start_conversation")}),Z.length>0&&t.jsxs(t.Fragment,{children:[t.jsx(l,{variant:"subtitle2",sx:{fontWeight:700,color:"#717171",mb:1,px:.5},children:i("chat.select_property")}),t.jsx(n,{sx:{overflowX:"hidden",pr:.5},children:Z.map(e=>t.jsx(n,{onClick:()=>ue(e.propertyId),sx:{p:1.5,mb:.5,borderRadius:1.5,cursor:"pointer",border:"1px solid #E5E7EB","&:hover":{bgcolor:"#F9FAFB",borderColor:"#AD542D"},opacity:I?.7:1,pointerEvents:I?"none":"auto"},children:t.jsxs(d,{direction:"row",spacing:1.5,useFlexGap:!0,alignItems:"center",children:[t.jsx(R,{src:e.hostAvatar??void 0,sx:{bgcolor:"#AD542D",width:40,height:40},children:e.hostName.charAt(0)}),t.jsxs(n,{sx:{minWidth:0,flex:1},children:[t.jsx(l,{variant:"body2",sx:{fontWeight:600,color:"#222222"},children:e.hostName}),t.jsx(l,{variant:"caption",sx:{color:"#717171",display:"block",overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap"},children:e.property})]})]})},e.propertyId))})]})]}),t.jsx(n,{sx:{flex:"0 0 auto"},children:g.map(e=>t.jsx(n,{onClick:()=>{j(e.id),b(s=>s.map(o=>o.id===e.id?{...o,unreadCount:0}:o))},sx:{p:2,borderBottom:"1px solid #E5E7EB",cursor:"pointer",bgcolor:c===e.id?"#FFF5F7":"transparent",position:"relative","&:hover":{bgcolor:c===e.id?"#FFF5F7":"#F9FAFB"}},children:t.jsxs(d,{direction:"row",spacing:2,useFlexGap:!0,alignItems:"flex-start",children:[t.jsx(R,{src:e.hostAvatar??void 0,sx:{bgcolor:"#AD542D",width:48,height:48},children:e.hostName.charAt(0)}),t.jsxs(n,{sx:{flex:1,minWidth:0},children:[t.jsxs(d,{direction:"row",justifyContent:"space-between",alignItems:"center",sx:{mb:.5},children:[t.jsx(l,{variant:"subtitle2",sx:{fontWeight:700,color:"#222222"},children:e.hostName}),t.jsxs(d,{direction:"row",spacing:1,useFlexGap:!0,alignItems:"center",children:[t.jsx(l,{variant:"caption",sx:{color:"#9CA3AF"},children:re(e.lastMessageTime)}),t.jsx(E,{size:"small",onClick:s=>{s.stopPropagation(),be(e.id,s)},sx:{p:.5},children:t.jsx(Ie,{sx:{fontSize:18,color:"#9CA3AF"}})}),t.jsxs(ke,{anchorEl:V[e.id],open:!!V[e.id],onClose:()=>T(e.id),children:[t.jsx(G,{onClick:()=>T(e.id),children:"Archive"}),t.jsx(G,{onClick:()=>T(e.id),children:"Delete"}),t.jsx(G,{onClick:()=>T(e.id),children:"Mute"})]})]})]}),t.jsxs(d,{direction:"row",justifyContent:"space-between",alignItems:"center",children:[oe(e)&&t.jsx(l,{variant:"body2",sx:{color:e.unreadCount>0?"#222222":"#717171",fontWeight:e.unreadCount>0?600:400,overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap",flex:1,marginInlineEnd:1},children:oe(e)}),e.unreadCount>0&&t.jsx(n,{sx:{bgcolor:"#AD542D",color:"#FFFFFF",borderRadius:"50%",width:20,height:20,display:"flex",alignItems:"center",justifyContent:"center",fontSize:"0.75rem",fontWeight:700},children:e.unreadCount})]})]})]})},e.id))})]})})}),(!H||c)&&t.jsx(le,{xs:12,md:8,lg:9,children:p?t.jsxs(O,{elevation:0,sx:{border:"1px solid #E5E7EB",borderRadius:2,height:"calc(100vh - 250px)",display:"flex",flexDirection:"column"},children:[t.jsx(n,{sx:{p:2,borderBottom:"1px solid #E5E7EB"},children:t.jsxs(d,{direction:"row",spacing:2,useFlexGap:!0,alignItems:"center",justifyContent:"space-between",children:[H&&t.jsx(E,{onClick:()=>j(null),sx:{mr:-1},"aria-label":i("chat.back"),children:t.jsx(Be,{sx:{fontSize:24,color:"#222222"}})}),t.jsxs(d,{direction:"row",spacing:2,useFlexGap:!0,alignItems:"center",sx:{minWidth:0,flex:1},children:[t.jsx(R,{src:p.hostAvatar??void 0,sx:{bgcolor:"#AD542D",width:40,height:40,flexShrink:0},children:p.hostName.charAt(0)}),t.jsxs(n,{sx:{minWidth:0},children:[t.jsx(l,{variant:"subtitle1",sx:{fontWeight:700,color:"#222222"},noWrap:!0,children:p.hostName}),t.jsx(l,{variant:"caption",sx:{color:"#717171"},noWrap:!0,display:"block",children:p.property})]})]})]})}),t.jsxs(n,{ref:Y,sx:{flex:1,overflowY:"auto",p:2,bgcolor:"#F9FAFB",display:"flex",flexDirection:"column",minHeight:0},children:[xe?t.jsx(n,{sx:{flex:1,display:"flex",alignItems:"center",justifyContent:"center",minHeight:200},children:t.jsx(l,{variant:"body2",sx:{color:"#717171"},children:i("chat.loading")})}):t.jsx(t.Fragment,{children:p.messages.map((e,s)=>{const o=s===0||new Date(e.timestamp).toDateString()!==new Date(p.messages[s-1].timestamp).toDateString();return t.jsxs(n,{children:[o&&t.jsx(n,{sx:{textAlign:"center",my:2},children:t.jsx(l,{variant:"caption",sx:{color:"#9CA3AF",bgcolor:"#F9FAFB",px:2,py:.5,borderRadius:1},children:re(e.timestamp)})}),t.jsx(d,{direction:"row",justifyContent:e.sender==="customer"?"flex-end":"flex-start",sx:{mb:1.5},children:e.files&&e.files.length>0&&!e.text?t.jsxs(n,{sx:{maxWidth:"70%",position:"relative"},children:[t.jsx(d,{spacing:1,children:e.files.map(r=>t.jsx(n,{sx:{position:"relative"},children:r.type==="image"?t.jsx(n,{component:"img",src:r.url,alt:r.name,sx:{maxWidth:"100%",maxHeight:300,borderRadius:2,objectFit:"cover",cursor:"pointer",display:"block"},onClick:()=>window.open(r.url,"_blank")}):t.jsx(n,{sx:{borderRadius:2,overflow:"hidden",maxHeight:300},children:t.jsx("video",{src:r.url,style:{maxWidth:"100%",maxHeight:300,display:"block"},controls:!0})})},r.id))}),t.jsx(l,{variant:"caption",sx:{color:"#9CA3AF",fontSize:"0.7rem",display:"block",mt:.5,textAlign:e.sender==="customer"?"right":"left"},children:se(e.timestamp)})]}):t.jsxs(We,{elevation:0,sx:{p:1.5,maxWidth:"70%",bgcolor:e.sender==="customer"?"#AD542D":"#FFFFFF",color:e.sender==="customer"?"#FFFFFF":"#222222",borderRadius:2,border:e.sender==="host"?"1px solid #E5E7EB":"none"},children:[e.files&&e.files.length>0&&t.jsx(d,{spacing:1,sx:{mb:e.text?1:0},children:e.files.map(r=>t.jsx(n,{children:r.type==="image"?t.jsx(n,{component:"img",src:r.url,alt:r.name,sx:{maxWidth:"100%",maxHeight:300,borderRadius:1,objectFit:"cover",cursor:"pointer"},onClick:()=>window.open(r.url,"_blank")}):t.jsx(n,{sx:{position:"relative",bgcolor:"rgba(0,0,0,0.5)",borderRadius:1,overflow:"hidden",minHeight:200,display:"flex",alignItems:"center",justifyContent:"center"},children:t.jsx("video",{src:r.url,style:{maxWidth:"100%",maxHeight:300,borderRadius:4},controls:!0})})},r.id))}),e.text&&t.jsx(l,{variant:"body2",sx:{mb:.5},children:e.text}),t.jsx(l,{variant:"caption",sx:{color:e.sender==="customer"?"rgba(255,255,255,0.7)":"#9CA3AF",fontSize:"0.7rem"},children:se(e.timestamp)})]})})]},e.id)})}),t.jsx("div",{ref:ce})]}),y.length>0&&t.jsx(n,{sx:{p:2,borderTop:"1px solid #E5E7EB",bgcolor:"#FFFFFF"},children:t.jsx(d,{direction:"row",spacing:1,useFlexGap:!0,sx:{flexWrap:"wrap",gap:1},children:y.map((e,s)=>t.jsxs(n,{sx:{position:"relative",border:"1px solid #E5E7EB",borderRadius:1,overflow:"hidden",width:80,height:80},children:[e.type.startsWith("image/")?t.jsx(n,{component:"img",src:URL.createObjectURL(e),alt:e.name,sx:{width:"100%",height:"100%",objectFit:"cover"}}):t.jsx(n,{sx:{width:"100%",height:"100%",display:"flex",alignItems:"center",justifyContent:"center",bgcolor:"#F9FAFB"},children:t.jsx(Se,{sx:{fontSize:32,color:"#717171"}})}),t.jsx(E,{size:"small",onClick:()=>ge(s),sx:{position:"absolute",top:4,right:4,bgcolor:"rgba(0,0,0,0.5)",color:"#FFFFFF",width:20,height:20,"&:hover":{bgcolor:"rgba(0,0,0,0.7)"}},children:"Ã—"})]},s))})}),t.jsx(n,{sx:{p:2,borderTop:"1px solid #E5E7EB"},children:t.jsxs(d,{direction:"row",spacing:1,useFlexGap:!0,alignItems:"flex-end",children:[t.jsx("input",{type:"file",ref:D,onChange:me,accept:"image/*,video/*",multiple:!0,style:{display:"none"}}),t.jsx(E,{onClick:()=>D.current?.click(),sx:{border:"1px solid #E5E7EB",borderRadius:2,width:40,height:40,color:"#717171","&:hover":{bgcolor:"#F9FAFB",borderColor:"#AD542D"}},children:t.jsx(Ae,{})}),t.jsx(Ne,{fullWidth:!0,placeholder:i("chat.type_placeholder"),value:F,onChange:e=>K(e.target.value),onKeyPress:fe,multiline:!0,maxRows:4,size:"small",sx:{"& .MuiOutlinedInput-root":{borderRadius:2,bgcolor:"#FFFFFF","& fieldset":{borderColor:"#E5E7EB"}}}}),t.jsx(B,{variant:"contained",onClick:()=>void te(),disabled:he||!F.trim()&&y.length===0,sx:{bgcolor:"#AD542D",borderRadius:2,minWidth:48,height:40,"&:hover":{bgcolor:"#78381C"},"&:disabled":{bgcolor:"#E5E7EB",color:"#9CA3AF"}},children:t.jsx(ne,{})})]})})]}):t.jsx(O,{elevation:0,sx:{border:"1px solid #E5E7EB",borderRadius:2,height:"calc(100vh - 250px)",display:"flex",alignItems:"center",justifyContent:"center"},children:t.jsxs(n,{sx:{textAlign:"center"},children:[t.jsx(n,{sx:{width:80,height:80,borderRadius:"50%",border:"2px solid #E5E7EB",display:"flex",alignItems:"center",justifyContent:"center",mx:"auto",mb:2},children:t.jsx(ne,{sx:{fontSize:40,color:"#9CA3AF"}})}),t.jsx(l,{variant:"h6",sx:{color:"#6B7280",mb:1},children:i("chat.select_conversation")}),t.jsx(l,{variant:"body2",sx:{color:"#9CA3AF"},children:i("chat.select_conversation_sub")})]})})})]})]})}),t.jsx(Ce,{}),t.jsxs(Le,{open:W,onClose:()=>{v(!1),w(null)},maxWidth:"sm",fullWidth:!0,PaperProps:{sx:{borderRadius:2,maxHeight:"80vh"}},children:[t.jsxs(Ge,{sx:{pb:1,display:"flex",justifyContent:"space-between",alignItems:"center"},children:[t.jsx(l,{variant:"h6",sx:{fontWeight:700,color:"#222222"},children:i("chat.start_conversation")}),t.jsx(E,{onClick:()=>{v(!1),w(null)},sx:{color:"#717171"},children:t.jsx(Te,{})})]}),t.jsxs(Oe,{sx:{p:0},children:[t.jsx(l,{variant:"body2",sx:{px:3,pb:2,color:"#717171"},children:i("chat.select_property")}),t.jsx(n,{sx:{maxHeight:"50vh",overflowY:"auto"},children:de?t.jsx(n,{sx:{py:4,textAlign:"center"},children:t.jsx(l,{variant:"body2",sx:{color:"#717171"},children:i("chat.loading")})}):q.length===0?t.jsx(n,{sx:{py:4,textAlign:"center"},children:t.jsx(l,{variant:"body2",sx:{color:"#717171"},children:i("chat.no_properties")})}):q.map(e=>t.jsx(n,{onClick:()=>w(e.propertyId),sx:{px:3,py:2,cursor:"pointer",bgcolor:C===e.propertyId?"#FFF5F7":"transparent",borderBottom:"1px solid #E5E7EB","&:hover":{bgcolor:C===e.propertyId?"#FFF5F7":"#F9FAFB"}},children:t.jsxs(d,{direction:"row",spacing:2,useFlexGap:!0,alignItems:"center",children:[t.jsx(R,{src:e.hostAvatar??void 0,sx:{bgcolor:"#AD542D",width:40,height:40},children:e.hostName.charAt(0)}),t.jsxs(n,{sx:{flex:1,minWidth:0},children:[t.jsx(l,{variant:"subtitle2",sx:{fontWeight:700,color:"#222222",mb:.5},children:e.hostName}),t.jsx(l,{variant:"body2",sx:{color:"#717171",fontSize:"0.875rem"},noWrap:!0,children:e.property})]})]})},e.propertyId))})]}),t.jsxs(Ue,{sx:{p:2,borderTop:"1px solid #E5E7EB"},children:[t.jsx(B,{onClick:()=>{v(!1),w(null)},sx:{color:"#717171",textTransform:"none",fontWeight:600},children:i("chat.cancel")}),t.jsx(B,{onClick:()=>void je(),disabled:!C||I,variant:"contained",sx:{bgcolor:"#AD542D",textTransform:"none",fontWeight:700,borderRadius:2,px:3,"&:hover":{bgcolor:"#78381C"},"&:disabled":{bgcolor:"#E5E7EB",color:"#9CA3AF"}},children:i(I?"chat.loading":"chat.start")})]})]})]})}export{pt as default};
